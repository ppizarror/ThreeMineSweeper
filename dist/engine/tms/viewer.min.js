/*
 MIT
*/
function TMSViewer(){this.id=generateID();this._canvasParent=null;var a=this;this._guiID="viewer-gui";this._animateThread=!1;this._threejs_helpers={axis:!1,cameratarget:!1,fpsmeter:!1,grid:!1,gui:!1,normals:!1,planes:!1,worldlimits:!1,axissize:.4,cameratargetcolor:255,griddist:.03,guicloseafterpopup:!1,guistartclosed:!1,normalcolor:16711680,planecolorx:255,planecolory:16711680,planecolorz:65280,planeopacity:.5,worldlimitscolor:4473924};this._helpersUpdate=[];this._helperInstances={axis:null,cameratarget:null,
fpsmeter:null,grid:null,planes:null,worldlimits:null};this._globals={contour:"__CONTOUR",helper:"__HELPER",normals:"__NORMALS",plane:"__PLANE",volume:"VOLUME"};this.worldsize={diagl:0,x:1,y:1,z:1};this._collaidableMeshes=[];this.objects_props={tooltip:{addMode:function(b){b=b.__eval;not_null_undf(b)&&a.objects_props.tooltip.modes.push(b)},container:"viewer",enabled:!1,ignoreEmpty:!0,left:20,mode:{group:{addContainer:function(b,c){a.objects_props.tooltip.mode.group.__groups.push(b);a.objects_props.tooltip.mode.group.__names[b]=
c},removeContainer:function(b){for(var c=0;c<a.objects_props.tooltip.mode.group.__groups.length;c+=1)if(a.objects_props.tooltip.mode.group.__groups[c]===b){a.objects_props.tooltip.mode.group.__groups.splice(c,1);break}delete a.objects_props.tooltip.mode.group.__names[b]},__names:{},__groups:[],__eval:function(b){try{for(var c=0;c<b.length;c+=1)if(-1!==a.objects_props.tooltip.mode.group.__groups.indexOf(b[c].object.name)&&0!==b[c].object.material[b[c].face.materialIndex].opacity)return a.objects_props.tooltip.mode.group.__names[b[c].object.name][b[c].face.materialIndex]}catch(d){}finally{}return""}},
mesh:{addIgnore:function(b){-1===a.objects_props.tooltip.mode.mesh.__ignored.indexOf(b)&&a.objects_props.tooltip.mode.mesh.__ignored.push(b)},delIgnore:function(b){b=a.objects_props.tooltip.mode.mesh.__ignored.indexOf(b);-1!==b&&a.objects_props.tooltip.mode.mesh.__ignored.splice(b,1)},__eval:function(b){try{for(var c=0;c<b.length;c+=1)if(-1===a.objects_props.tooltip.mode.mesh.__ignored.indexOf(b[c].object.name)&&0!==b[c].object.material.opacity)return b[c].object.name}catch(d){}finally{}return""},
__ignored:[this._globals.plane,this._globals.contour,this._globals.helper]}},modes:[],tooltipClass:"viewer-tooltip",top:-12},camera:{angle:60,autorotate:!1,bounds:{x:6,y:6,z:6},brakeaccel:{alf:2950,aup:3950,f:600,p:600,x:600,y:600,z:600},collidevolume:!1,collidelimits:!1,damping:!0,dampingfactor:.1,facerotate:!1,facetarget:{x:null,y:null,z:null},far:9,light:{color:8355711,decay:2,distance:4.2,intensity:1.2},maxdistance:2.5,maxpolarangle:Math.PI,maxvelocity:{alf:.006,aup:.006,f:.02,p:.05,x:.05,y:.05,
z:.035},minspeed:1E-4,minspeedangle:1E-5,movements:{angledown:!1,angleleft:!1,angleright:!1,angleup:!1,backward:!1,facerotate:!1,forward:!1,left:!1,pan:!1,planebackward:!1,planeforward:!1,right:!1,rotate:!1,zdown:!1,zup:!1},movs:{angle:"angle",ortho:"ortho",parallel:"parallel",vertical:"vertical"},near:.001,pan:!0,panaddfactor:.4,panaddtospeed:!1,panfactor:1E-4,panspeed:5,posx:2.3,posy:-2.3,posz:2,radius:.995,ray:null,raycollidedist:.08,rotatespeed:.06,speedfactor:{inside:.6,outside:.85},targetaccel:{alf:.008,
aup:.008,f:.02,p:.03,x:.05,y:.05,z:.05},targetdamping:{alf:.03,aup:.03,f:.05,p:.05,x:.09,y:.09,z:.07},targetspeed:{alf:0,aup:0,f:0,p:0,x:0,y:0,z:0},zoom:1,zoomaddfactor:.5,zoomaddtospeed:!0,zoomspeed:5E-5},ambientlight:{color:16777215,intensity:.3},light:{angle:1.6,color:16777215,decay:1.6,distance:.793,intensity:0,penumbra:.58,planeshadow:!1,pos:{x:0,y:0,z:1}},fog:{color:1250067,density:2.4E-4,enabled:!0}};this._textureLoader=new THREE.TextureLoader;a._textureLoader.setPath("resources/tiles/");this.images=
{};this._load_image_file=function(b){not_null_undf(this.images[b])||(this.images[b]=a._textureLoader.load("{0}.png".format(b)),this.images[b+"_ambient"]=a._textureLoader.load("{0}_ambient.png".format(b)),this.images[b+"_normal"]=a._textureLoader.load("{0}_normal.png".format(b)),this.images[b+"_specular"]=a._textureLoader.load("{0}_specular.png".format(b)))};this._textures_loaded=!1;this._load_textures=function(){if(!this._textures_loaded){a._textures_loaded=!0;for(var b="bomb disabled flag question tile_0 tile_1 tile_2 tile_3 tile_4 tile_5 tile_6 tile_7 tile_8 unopened".split(" "),
c=0;c<b.length;c+=1)this._load_image_file(b[c])}};this._volume=null;this.palette={contour_major:!0,contour_major_color:4473924,contour_major_opacity:1,contour_minor:!1,contour_minor_color:0,contour_minor_opacity:1,face_color_played:new THREE.Color(7829367),face_color_unplayed:new THREE.Color(16777215),face_exploded:new THREE.Color(16718362),face_hover_played:new THREE.Color(0),face_hover_unplayed:new THREE.Color(5592405),face_shininess_played:15,face_shininess_unplayed:50,face_specular:1052688,face_unhover_played:new THREE.Color(0),
face_unhover_unplayed:new THREE.Color(65793)};this._volume_meshes={contourmajor:null,contourminor:[],helper:null,volume:null};this.three_resize=function(b){var c="resize.shaderviewer"+this.id;b?(b=function(b){not_null_undf(b)&&b.preventDefault();b=Math.ceil(get_element_width(a.maindiv));var c=Math.ceil(get_element_height(a.maindiv));a.objects_props.camera.aspect=b/c;a._three_camera.aspect=b/c;a._three_camera.updateProjectionMatrix();a._renderer.setSize(b,c);a._renderer.setPixelRatio(window.devicePixelRatio);
a.animate_frame()},app_dom.window.on(c,b),b()):app_dom.window.off(c)};this._init_three=function(){this.worldsize.diagl=Math.sqrt(Math.pow(2*this.worldsize.x,2)+Math.pow(2*this.worldsize.y,2)+Math.pow(this.worldsize.z,2));this.worldsize.diagx=Math.sqrt(Math.pow(2*this.worldsize.x,2)+Math.pow(this.worldsize.z,2));this.worldsize.diagy=Math.sqrt(Math.pow(2*this.worldsize.y,2)+Math.pow(this.worldsize.z,2));this.objects_props.camera.far*=this.worldsize.diagl;this.objects_props.camera.maxdistance*=this.worldsize.diagl;
this.objects_props.camera.maxpolarangle*=Math.PI/2;this.objects_props.camera.maxvelocity.f*=this.worldsize.diagl;this.objects_props.camera.maxvelocity.x*=this.worldsize.x;this.objects_props.camera.maxvelocity.y*=this.worldsize.y;this.objects_props.camera.maxvelocity.z*=this.worldsize.z;this.objects_props.camera.minspeed*=this.worldsize.diagl;this.objects_props.camera.panspeed*=this.worldsize.diagl;this.objects_props.camera.zoomspeed*=this.worldsize.diagl;this.objects_props.camera.light.distance*=
this.worldsize.diagl;this.objects_props.light.distance*=this.worldsize.diagl;this.objects_props.light.pos.x*=this.worldsize.x;this.objects_props.light.pos.y*=this.worldsize.y;this.objects_props.light.pos.z*=this.worldsize.z;this._renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0,depth:!0,logarithmicDepthBuffer:!1,powerPreference:"default",precision:"lowp",premultipliedAlpha:!0,preserveDrawingBuffer:!1,stencil:!0});this._scene=new THREE.Scene;this._scene.name="VIEWER-3D-SCENE";this._light=new THREE.SpotLight;
this._light.castShadow=!0;this._light.color.setHex(a.objects_props.light.color);this._light.decay=a.objects_props.light.decay;this._light.distance=this.worldsize.diagl;this._light.intensity=a.objects_props.light.intensity;this._light.penumbra=a.objects_props.light.penumbra;this._light.angle=a.objects_props.light.angle;this._light.position.x=this.objects_props.light.pos.y;this._light.position.y=this.objects_props.light.pos.z;this._light.position.z=this.objects_props.light.pos.x;this._light.shadow.mapSize.height=
512;this._light.shadow.mapSize.width=512;this._scene.add(this._light);this._fog=new THREE.FogExp2(this.objects_props.fog.color,this.objects_props.fog.density);this.objects_props.fog.enabled&&(this._scene.fog=this._fog);this._ambientlight=new THREE.AmbientLight;this._ambientlight.color.setHex(this.objects_props.ambientlight.color);this._ambientlight.intensity=this.objects_props.ambientlight.intensity;this._scene.add(this._ambientlight);this._renderer.shadowMap.enabled=!0;this._renderer.shadowMap.type=
THREE.PCFSoftShadowMap;this._renderer.gammaInput=!0;this._renderer.gammaOutput=!0;this._three_camera=new THREE.PerspectiveCamera(a.objects_props.camera.angle,a.objects_props.camera.aspect,a.objects_props.camera.near,a.objects_props.camera.far);this._three_camera.zoom=this.objects_props.camera.zoom;this._cameralight=new THREE.PointLight;this._cameralight.color.setHex(this.objects_props.camera.light.color);this._cameralight.decay=this.objects_props.camera.light.decay;this._cameralight.distance=this.objects_props.camera.light.distance;
this._cameralight.intensity=this.objects_props.camera.light.intensity;this._cameralight.castShadow=!0;this._cameralight.shadow.mapSize.height=256;this._cameralight.shadow.mapSize.width=256;this._three_camera.add(this._cameralight);this.maindiv=$(a.id);this.maindiv.append(this._renderer.domElement);this._canvasParent.attr("tabindex","1");this._scene.add(this._three_camera);this._controls=new THREE.OrbitControls(this._three_camera,$("#game-ui")[0]);this._controls.autoRotate=this.objects_props.camera.autorotate;
this._controls.dampingFactor=this.objects_props.camera.dampingfactor;this._controls.enableDamping=this.objects_props.camera.damping;this._controls.enableKey=!1;this._controls.enablePan=this.objects_props.camera.pan;this._controls.enableZoom=!0;this._controls.maxDistance=this.objects_props.camera.maxdistance;this._controls.maxPolarAngle=this.objects_props.camera.maxpolarangle;this._controls.panFunction=this._move_ortho;this._controls.panSpeed=this.objects_props.camera.panspeed*a.worldsize.diagl;this._controls.rotatespeed=
this.objects_props.camera.rotatespeed;this._controls.viewerCamera=this.objects_props.camera;this._controls.zoomFunction=this._move_parallel;this.set_camera_pos(this.worldsize.x,this.worldsize.y,this.worldsize.z);this._raycaster=new THREE.Raycaster;this.objects_props.camera.collidevolume&&(this.objects_props.camera.ray=new THREE.Raycaster,this.objects_props.camera.ray.far=2*this.objects_props.camera.raycollidedist);this._threejs_helpers.gui&&(this._threejs_helpers.gui=!1,this.toggle_gui());this._threejs_helpers.fpsmeter&&
this.toggle_fps_meter()};this.set_camera_pos=function(b,c,d){if(-1===b||-1===c||-1===d)b=this.worldsize.x,c=this.worldsize.y,d=this.worldsize.z;b*=this.worldsize.x;c*=this.worldsize.y;d*=this.worldsize.z;a.objects_props.camera.initialPosition={x:b,y:c,z:d};this.objects_props.camera.target={x:b*this.objects_props.camera.radius,y:c*this.objects_props.camera.radius,z:d*this.objects_props.camera.radius};this.objects_props.camera.target.x*=this.worldsize.x;this.objects_props.camera.target.y*=this.worldsize.y;
this.objects_props.camera.target.z*=this.worldsize.z;a.objects_props.camera.initialTarget={x:this.objects_props.camera.target.x,y:this.objects_props.camera.target.y,z:this.objects_props.camera.target.z};this._place_camera()};this._place_camera=function(){a._three_camera.position.x=a.objects_props.camera.initialPosition.y;a._three_camera.position.y=a.objects_props.camera.initialPosition.z;a._three_camera.position.z=a.objects_props.camera.initialPosition.x;a.objects_props.camera.target.x=a.objects_props.camera.initialTarget.x;
a.objects_props.camera.target.y=a.objects_props.camera.initialTarget.y;a.objects_props.camera.target.z=a.objects_props.camera.initialTarget.z;a._set_camera_target()};this._set_camera_target=function(){a._controls.target.set(a.objects_props.camera.target.y,a.objects_props.camera.target.z,a.objects_props.camera.target.x);a._controls.update()};this.render=function(){a._renderer.render(a._scene,a._three_camera);for(var b=0;b<a._helpersUpdate.length;b+=1)a._helpersUpdate[b].update();not_null_undf(a._gui)&&
(a._guiCameraParams.posx=round_number(a._three_camera.position.z,3),a._guiCameraParams.posy=round_number(a._three_camera.position.x,3),a._guiCameraParams.posz=round_number(a._three_camera.position.y,3))};this.animate_frame=function(){a._update_camera_speed();a._move_camera();a._controls.update();a.render()};this._animation_thread=function(){a._animateThread&&(requestAnimationFrame(a._animation_thread),a.animate_frame())};this.init_animate=function(){a._animateThread||(a._animateThread=!0,this._animation_thread())};
this.stop_animate=function(){a._animateThread&&(a._animateThread=!1)};this._init_world_objects=function(){this._draw_helpers();this._set_camera_target();this._save_initial_status()};this._save_initial_status=function(){a.objects_props.camera.initialTarget.x=a.objects_props.camera.target.x;a.objects_props.camera.initialTarget.y=a.objects_props.camera.target.y;a.objects_props.camera.initialTarget.z=a.objects_props.camera.target.z};this._check_camera_target_collision=function(b,c){var d=a.objects_props.camera.target[b]+
c;if(a.objects_props.camera.collidelimits&&(d<-a.objects_props.camera.bounds[b]*a.worldsize[b]||d>a.objects_props.camera.bounds[b]*a.worldsize[b]))return a.stop_camera();if(a.objects_props.camera.collidevolume&&a._camera_inside()){var f=a.objects_props.camera.ray,e={x:a.objects_props.camera.target.y,y:a.objects_props.camera.target.z,z:a.objects_props.camera.target.x};"x"===b&&(e.z+=c);"y"===b&&(e.x+=c);"z"===b&&(e.y+=c);f.set(e,{x:e.x-a._three_camera.position.x,y:e.y-a._three_camera.position.y,z:e.z-
a._three_camera.position.z});c=f.intersectObjects(a._collaidableMeshes,!1);if(0<c.length&&c[0].distance<a.objects_props.camera.raycollidedist)return a.stop_camera()}a.objects_props.camera.target[b]=d;return!0};this._update_camera_target=function(b,c,d){switch(b){case "x":a._check_camera_target_collision(b,c)&&(a._three_camera.position.z+=c);break;case "y":a._check_camera_target_collision(b,c)&&(a._three_camera.position.x+=c);break;case "z":a._check_camera_target_collision(b,c)&&(a._three_camera.position.y+=
c)}d&&a._set_camera_target()};this._update_camera_speed=function(){var b=1/60,c=0,d=0,f=0,e=0,g=0,l=0,h=0;a.objects_props.camera.movements.forward&&(c=-1);a.objects_props.camera.movements.backward&&(c=1);a.objects_props.camera.movements.left&&(l=g=-1);a.objects_props.camera.movements.right&&(l=g=1);a.objects_props.camera.movements.zup&&(h=-1);a.objects_props.camera.movements.zdown&&(h=1);a.objects_props.camera.movements.angleup&&(e=-1);a.objects_props.camera.movements.angledown&&(e=1);a.objects_props.camera.movements.planeforward&&
(f=-1);a.objects_props.camera.movements.planebackward&&(f=1);a.objects_props.camera.movements.angleleft&&(d=-1);a.objects_props.camera.movements.angleright&&(d=1);a.objects_props.camera.movements.left&&a.objects_props.camera.movements.right&&(l=g=0);a.objects_props.camera.movements.zup&&a.objects_props.camera.movements.zdown&&(h=0);a.objects_props.camera.movements.angledown&&a.objects_props.camera.movements.angleup&&(e=0);a.objects_props.camera.movements.angleleft&&a.objects_props.camera.movements.angleright&&
(d=0);a.objects_props.camera.movements.planeforward&&a.objects_props.camera.movements.planebackward&&(f=0);if(0!==g||0!==l||0!==h||0!==c||0!==e||0!==d||0!==f||a.camera_is_moving()||a.camera_is_rotating()){a._different_sign(g,a.objects_props.camera.targetspeed.x)&&(g*=Math.abs(a.objects_props.camera.brakeaccel.x*a.objects_props.camera.targetspeed.x));a._different_sign(l,a.objects_props.camera.targetspeed.y)&&(l*=Math.abs(a.objects_props.camera.brakeaccel.y*a.objects_props.camera.targetspeed.y));a._different_sign(h,
a.objects_props.camera.targetspeed.z)&&(h*=Math.abs(a.objects_props.camera.brakeaccel.z*a.objects_props.camera.targetspeed.z));a._different_sign(c,a.objects_props.camera.targetspeed.f)&&(c*=Math.abs(a.objects_props.camera.brakeaccel.f*a.objects_props.camera.targetspeed.f));a._different_sign(f,a.objects_props.camera.targetspeed.p)&&(f*=Math.abs(a.objects_props.camera.brakeaccel.p*a.objects_props.camera.targetspeed.p));a._different_sign(e,a.objects_props.camera.targetspeed.aup)&&(e*=Math.abs(a.objects_props.camera.brakeaccel.aup*
a.objects_props.camera.targetspeed.aup));a._different_sign(d,a.objects_props.camera.targetspeed.alf)&&(d*=Math.abs(a.objects_props.camera.brakeaccel.alf*a.objects_props.camera.targetspeed.alf));var k=a._camera_inside()?a.objects_props.camera.speedfactor.inside:a.objects_props.camera.speedfactor.outside;a.objects_props.camera.targetspeed.alf+=d*a.objects_props.camera.targetaccel.alf*b;a.objects_props.camera.targetspeed.aup+=e*a.objects_props.camera.targetaccel.aup*b;a.objects_props.camera.targetspeed.f+=
c*a.objects_props.camera.targetaccel.f*a.worldsize.diagl*b*k;a.objects_props.camera.targetspeed.p+=f*a.objects_props.camera.targetaccel.p*a.worldsize.diagl*b*k;a.objects_props.camera.targetspeed.x+=g*a.objects_props.camera.targetaccel.x*a.worldsize.x*b*k;a.objects_props.camera.targetspeed.y+=l*a.objects_props.camera.targetaccel.y*a.worldsize.y*b*k;a.objects_props.camera.targetspeed.z+=h*a.objects_props.camera.targetaccel.z*a.worldsize.z*b*k;var m=a.objects_props.camera.targetspeed.f,n=a.objects_props.camera.targetspeed.alf,
p=a.objects_props.camera.targetspeed.p,q=a.objects_props.camera.targetspeed.aup,r=a.objects_props.camera.targetspeed.x,t=a.objects_props.camera.targetspeed.y,u=a.objects_props.camera.targetspeed.z;0===c&&(a.objects_props.camera.targetspeed.f+=-Math.sign(a.objects_props.camera.targetspeed.f)*a.objects_props.camera.targetdamping.f*a.worldsize.diagl*b);0===d&&(a.objects_props.camera.targetspeed.alf+=-Math.sign(a.objects_props.camera.targetspeed.alf)*a.objects_props.camera.targetdamping.alf*b);0===f&&
(a.objects_props.camera.targetspeed.p+=-Math.sign(a.objects_props.camera.targetspeed.p)*a.objects_props.camera.targetdamping.p*a.worldsize.diagl*b);0===e&&(a.objects_props.camera.targetspeed.aup+=-Math.sign(a.objects_props.camera.targetspeed.aup)*a.objects_props.camera.targetdamping.aup*b);0===g&&(a.objects_props.camera.targetspeed.x+=-Math.sign(a.objects_props.camera.targetspeed.x)*a.objects_props.camera.targetdamping.x*a.worldsize.x*b);0===l&&(a.objects_props.camera.targetspeed.y+=-Math.sign(a.objects_props.camera.targetspeed.y)*
a.objects_props.camera.targetdamping.y*a.worldsize.y*b);0===h&&(a.objects_props.camera.targetspeed.z+=-Math.sign(a.objects_props.camera.targetspeed.z)*a.objects_props.camera.targetdamping.z*a.worldsize.z*b);if(a._different_sign(m,a.objects_props.camera.targetspeed.f)||Math.abs(a.objects_props.camera.targetspeed.f)<a.objects_props.camera.minspeed)a.objects_props.camera.targetspeed.f=0;if(a._different_sign(p,a.objects_props.camera.targetspeed.p)||Math.abs(a.objects_props.camera.targetspeed.p)<a.objects_props.camera.minspeed)a.objects_props.camera.targetspeed.p=
0;if(a._different_sign(n,a.objects_props.camera.targetspeed.alf)||Math.abs(a.objects_props.camera.targetspeed.alf)<a.objects_props.camera.minspeedangle)a.objects_props.camera.targetspeed.alf=0;if(a._different_sign(q,a.objects_props.camera.targetspeed.aup)||Math.abs(a.objects_props.camera.targetspeed.aup)<a.objects_props.camera.minspeedangle)a.objects_props.camera.targetspeed.aup=0;if(a._different_sign(r,a.objects_props.camera.targetspeed.x)||Math.abs(a.objects_props.camera.targetspeed.x)<a.objects_props.camera.minspeed)a.objects_props.camera.targetspeed.x=
0;if(a._different_sign(t,a.objects_props.camera.targetspeed.y)||Math.abs(a.objects_props.camera.targetspeed.y)<a.objects_props.camera.minspeed)a.objects_props.camera.targetspeed.y=0;if(a._different_sign(u,a.objects_props.camera.targetspeed.z)||Math.abs(a.objects_props.camera.targetspeed.z)<a.objects_props.camera.minspeed)a.objects_props.camera.targetspeed.z=0;a.objects_props.camera.targetspeed.alf=Math.sign(a.objects_props.camera.targetspeed.alf)*Math.min(Math.abs(a.objects_props.camera.targetspeed.alf),
a.objects_props.camera.maxvelocity.alf);a.objects_props.camera.targetspeed.aup=Math.sign(a.objects_props.camera.targetspeed.aup)*Math.min(Math.abs(a.objects_props.camera.targetspeed.aup),a.objects_props.camera.maxvelocity.aup);a.objects_props.camera.targetspeed.f=Math.sign(a.objects_props.camera.targetspeed.f)*Math.min(Math.abs(a.objects_props.camera.targetspeed.f),a.objects_props.camera.maxvelocity.f*k);a.objects_props.camera.targetspeed.p=Math.sign(a.objects_props.camera.targetspeed.p)*Math.min(Math.abs(a.objects_props.camera.targetspeed.p),
a.objects_props.camera.maxvelocity.p*k);a.objects_props.camera.targetspeed.x=Math.sign(a.objects_props.camera.targetspeed.x)*Math.min(Math.abs(a.objects_props.camera.targetspeed.x),a.objects_props.camera.maxvelocity.x*k);a.objects_props.camera.targetspeed.y=Math.sign(a.objects_props.camera.targetspeed.y)*Math.min(Math.abs(a.objects_props.camera.targetspeed.y),a.objects_props.camera.maxvelocity.y*k);a.objects_props.camera.targetspeed.z=Math.sign(a.objects_props.camera.targetspeed.z)*Math.min(Math.abs(a.objects_props.camera.targetspeed.z),
a.objects_props.camera.maxvelocity.z*k)}};this._camera_inside=function(){return Math.abs(this._controls.target.x)<this.worldsize.x&&Math.abs(this._controls.target.y)<this.worldsize.y&&Math.abs(this._controls.target.z)<this.worldsize.z};this.stop_camera=function(){for(var b=Object.keys(a.objects_props.camera.movements),c=0;c<b.length;c+=1)a.objects_props.camera.movements[b[c]]=!1;b=Object.keys(a.objects_props.camera.targetspeed);for(c=0;c<b.length;c+=1)a.objects_props.camera.targetspeed[b[c]]=0;return!1};
this.camera_is_moving=function(){return 0!==a.objects_props.camera.targetspeed.x||0!==a.objects_props.camera.targetspeed.y||0!==a.objects_props.camera.targetspeed.z||0!==a.objects_props.camera.targetspeed.f||0!==a.objects_props.camera.targetspeed.p};this.camera_is_rotating=function(){return 0!==a.objects_props.camera.targetspeed.aup||0!==a.objects_props.camera.targetspeed.alf};this._different_sign=function(a,c){return 0<a&&0>c||0>a&&0<c};this._move_camera=function(){a._move_angle();a.camera_is_moving()&&
(a._move_parallel(),a._move_ortho(),a._move_vertical())};this._move_parallel=function(b){var c=a._controls.getAzimuthalAngle(),d=a._controls.getPolarAngle(),f=a.objects_props.camera.targetspeed.f;not_null_undf(b)&&(f=b*a.objects_props.camera.zoomspeed,a.objects_props.camera.zoomaddtospeed&&(a.objects_props.camera.targetspeed.f+=f*a.objects_props.camera.zoomaddfactor));b=f*Math.sin(c)*Math.sin(d);var e=f*Math.cos(d);a._update_camera_target("x",f*Math.cos(c)*Math.sin(d),!1);a._update_camera_target("y",
b,!1);a._update_camera_target("z",e,!0)};this._move_ortho=function(b,c){var d=a._controls.getAzimuthalAngle();if(not_null_undf(b)&&not_null_undf(c))if(a.objects_props.camera.facerotate&&a.objects_props.camera.movements.facerotate)a._move_face_rotate(.001*b,.001*c);else{if(a.objects_props.camera.movements.pan){b*=-a.objects_props.camera.panfactor;c*=-a.objects_props.camera.panfactor;var f=b*Math.cos(d+Math.PI/2);b*=Math.sin(d+Math.PI/2);a.objects_props.camera.panaddtospeed&&(a.objects_props.camera.targetspeed.x+=
f*a.objects_props.camera.dampingfactor*a.objects_props.camera.panaddfactor,a.objects_props.camera.targetspeed.y+=b*a.objects_props.camera.dampingfactor*a.objects_props.camera.panaddfactor,a.objects_props.camera.targetspeed.p+=c*a.objects_props.camera.dampingfactor*a.objects_props.camera.panaddfactor);a._update_camera_target("x",f,!1);a._update_camera_target("y",b,!1);a._update_camera_target("x",c*Math.cos(d),!1);a._update_camera_target("y",c*Math.sin(d),!0)}}else b=a.objects_props.camera.targetspeed.x*
Math.cos(d+Math.PI/2),c=a.objects_props.camera.targetspeed.y*Math.sin(d+Math.PI/2),a._update_camera_target("x",b,!1),a._update_camera_target("y",c,!1),b=a.objects_props.camera.targetspeed.p*Math.cos(d),c=a.objects_props.camera.targetspeed.p*Math.sin(d),a._update_camera_target("x",b,!1),a._update_camera_target("y",c,!0)};this._move_face_rotate=function(b,c){if(is_null_undf(a.objects_props.camera.facetarget.x)||is_null_undf(a.objects_props.camera.facetarget.y)||is_null_undf(a.objects_props.camera.facetarget.z)||
a.camera_is_moving())a.objects_props.camera.movements.facerotate=!1;else{var d=a._dist_camera_xyz(a.objects_props.camera.facetarget.x,a.objects_props.camera.facetarget.y,a.objects_props.camera.facetarget.z),f=a.objects_props.camera.facetarget.x,e=a.objects_props.camera.facetarget.y,g=a._three_camera.position.z,l=a._three_camera.position.x,h=Math.atan((l-e)/Math.abs(g-f+MIN_TOL)),k=Math.PI/2-Math.atan((a._three_camera.position.y-a.objects_props.camera.facetarget.z)/Math.sqrt(Math.pow(g-f,2)+Math.pow(l-
e,2)+MIN_TOL));f=d*Math.cos(h)*Math.sin(k);e=d*Math.sin(h)*Math.sin(k);g=d*Math.cos(k);k+=c;h+=b;l=d*Math.cos(h)*Math.sin(k);h=d*Math.sin(h)*Math.sin(k);d*=Math.cos(k);a._controls.rotateLeft(.01*b);a._controls.rotateUp(.01*c);a._update_camera_target("x",l-f,!1);a._update_camera_target("y",h-e,!1);a._update_camera_target("z",d-g,!0)}};this._dist_camera_xyz=function(b,c,d){return Math.sqrt(Math.pow(b-a._three_camera.position.z,2)+Math.pow(c-a._three_camera.position.x,2)+Math.pow(d-a._three_camera.position.y,
2))};this._move_vertical=function(){a._update_camera_target("z",a.objects_props.camera.targetspeed.z,!0)};this._move_angle=function(){a.camera_is_rotating()&&(a._controls.rotateLeft(a.objects_props.camera.targetspeed.alf),a._controls.rotateUp(a.objects_props.camera.targetspeed.aup))};this.focus=function(){a._canvasParent.trigger("focus")};this._rgb2hex=function(a){a=a.toString(16);a=1===a.length?"0"+a:a;return a.toString()};this._init_tooltip=function(){this.objects_props.tooltip.enabled=!0;not_null_undf(this.objects_props.tooltip.obj)&&
this.objects_props.tooltip.obj.remove();var b=generateID();$("#"+this.objects_props.tooltip.container).append('<div id="{0}" class="{1}"></div>'.format(b,this.objects_props.tooltip.tooltipClass));this.objects_props.tooltip.obj=$("#"+b);a.objects_props.tooltip.enabled=!1;a.objects_props.tooltip.addMode(a.objects_props.tooltip.mode.group)};this.reset_camera=function(){a._place_camera();a.stop_camera();a.animate_frame()};this._toggle_helper=function(){a._draw_helpers();a.animate_frame();a.focus()};this.toggle_axis=
function(){a._threejs_helpers.axis=!a._threejs_helpers.axis;a._toggle_helper()};this.toggle_grid=function(){a._threejs_helpers.grid=!a._threejs_helpers.grid;a._toggle_helper()};this.toggle_world_limits=function(){a._threejs_helpers.worldlimits=!a._threejs_helpers.worldlimits;a._toggle_helper()};this.toggle_camera_target=function(){a._threejs_helpers.cameratarget=!a._threejs_helpers.cameratarget;a._toggle_helper()};this.toggle_planes=function(){a._threejs_helpers.planes=!a._threejs_helpers.planes;
a._toggle_helper()};this.toggle_gui=function(){a._threejs_helpers.gui=!a._threejs_helpers.gui;a._threejs_helpers.gui?app_library_manager.import_async_library(app_library_manager.lib.DATGUI,a._build_gui):a._destroy_gui()};this.show_renderer_info=function(){var b=a._renderer.info;app_dialog.text("memory.<b>geometries</b>: {0}<br>memory.<b>textures</b>: {1}<br>render.<b>calls</b>: {2}<br>render.<b>frame</b>: {3}<br>render.<b>lines</b>: {4}<br>render.<b>points</b>: {5}<br>render.<b>triangles</b>: {6}<br>camera.<b>azimuth</b>: {7}<br>camera.<b>polar</b>: {8}".format(b.memory.geometries.toLocaleString(),
b.memory.textures.toLocaleString(),b.render.calls.toLocaleString(),b.render.frame.toLocaleString(),b.render.lines.toLocaleString(),b.render.points.toLocaleString(),b.render.triangles.toLocaleString(),round_number(a._controls.getAzimuthalAngle(),3),round_number(a._controls.getPolarAngle(),3)),lang.viewer_renderer_info)};this._dist_origin_xyz=function(a,c,d){return Math.sqrt(Math.pow(a,2)+Math.pow(c,2)+Math.pow(d,2))};this._build_gui=function(){this._gui=new dat.GUI({autoPlace:!1});this._ambientLightParam=
{color:a._ambientlight.color.getHex(),intensity:a._ambientlight.intensity,exportLight:function(){var b="0X"+a._rgb2hex(a._ambientLightParam.color).toUpperCase();app_dialog.text("<b>light.color</b>: <i>{0}</i>".format(b),lang.viewer_gui_export_light_title);a._threejs_helpers.guicloseafterpopup&&a._gui.close()}};var b=this._gui.addFolder(lang.viewer_gui_ambientlight);b.addColor(this._ambientLightParam,"color").onChange(function(b){a._ambientlight.color.setHex(b);a.render()});b.add(this._ambientLightParam,
"intensity",0,5).onChange(function(b){a._ambientlight.intensity=b;a.render()});b.add(this._ambientLightParam,"exportLight");this._cameraLightParam={color:a._cameralight.color.getHex(),intensity:a._cameralight.intensity,distance:a._cameralight.distance,decay:a._cameralight.decay,exportLight:function(){var b="0X"+a._rgb2hex(a._cameraLightParam.color).toUpperCase();var d=round_number(a._cameralight.distance/a.worldsize.diagl,3);app_dialog.text("<b>light.color</b>: <i>{0}</i><br><b>light.distance</b>: <i>{1}</i>".format(b,
d),lang.viewer_gui_export_light_title);a._threejs_helpers.guicloseafterpopup&&a._gui.close()}};b=this._gui.addFolder(lang.viewer_gui_cameralight);b.addColor(this._cameraLightParam,"color").onChange(function(b){a._cameralight.color.setHex(b);a.render()});b.add(this._cameraLightParam,"intensity",0,5).onChange(function(b){a._cameralight.intensity=b;a.render()});b.add(this._cameraLightParam,"distance",0,3*a.worldsize.diagl).onChange(function(b){a._cameralight.distance=b;a.render()});b.add(this._cameraLightParam,
"decay",1,2).onChange(function(b){a._cameralight.decay=b;a.render()});b.add(this._cameraLightParam,"exportLight");this._guiLightParam={color:a._light.color.getHex(),intensity:a._light.intensity,distance:a._light.distance,angle:a._light.angle,penumbra:a._light.penumbra,decay:a._light.decay,posx:a._light.position.z,posy:a._light.position.x,posz:a._light.position.y,planeshadow:a.objects_props.light.planeshadow,radius:a._dist_origin_xyz(a._light.position.x,a._light.position.y,a._light.position.z),rotatexy:(180*
Math.atan2(this._light.position.z,this._light.position.x)/Math.PI+360)%360,rotatexz:0,rotateyz:0,mapsizeh:a._light.shadow.mapSize.height,mapsizew:a._light.shadow.mapSize.width,exportLight:function(){var b=round_number(a._light.position.z/a.worldsize.x,3);var d=round_number(a._light.position.x/a.worldsize.y,3);var f=round_number(a._light.position.y/a.worldsize.z,3);var e=round_number(a._light.distance/a.worldsize.diagl,3);var g="0X"+a._rgb2hex(a._guiLightParam.color).toUpperCase();app_dialog.text("<b>light.color</b>: <i>{4}</i><br><b>light.pos.x</b>: <i>{0}</i><br><b>light.pos.y</b>: <i>{1}</i><br><b>light.pos.z</b>: <i>{2}</i><br><b>light.distance</b>: <i>{3}</i>".format(b,
d,f,e,g),lang.viewer_gui_export_light_title);a._threejs_helpers.guicloseafterpopup&&a._gui.close()}};b=this._gui.addFolder(lang.viewer_gui_light);b.addColor(this._guiLightParam,"color").onChange(function(b){a._light.color.setHex(b);a.render()});b.add(this._guiLightParam,"intensity",0,10).onChange(function(b){a._light.intensity=b;a.render()});b.add(this._guiLightParam,"distance",.01,3*a.worldsize.diagl).onChange(function(b){a._light.distance=b;a.render()});b.add(this._guiLightParam,"angle",.01,Math.PI/
2).onChange(function(b){a._light.angle=b;a.render()});b.add(this._guiLightParam,"penumbra",0,1).onChange(function(b){a._light.penumbra=b;a.render()});b.add(this._guiLightParam,"decay",1,2).onChange(function(b){a._light.decay=b;a.render()});b.add(this._guiLightParam,"posx",-a.worldsize.diagl,a.worldsize.diagl).onChange(function(b){a._light.position.z=b;a.render();a._guiLightParam.rotatexy=(180*Math.atan2(a._light.position.x,a._light.position.z)/Math.PI+360)%360}).listen();b.add(this._guiLightParam,
"posy",-a.worldsize.diagl,a.worldsize.diagl).onChange(function(b){a._light.position.x=b;a.render()}).listen();b.add(this._guiLightParam,"posz",0,a.worldsize.diagl).onChange(function(b){a._light.position.y=b;a.render()}).listen();b.add(this._guiLightParam,"radius",.01,a.worldsize.diagl).onChange(function(b){var c=a._dist_origin_xyz(a._light.position.x,a._light.position.y,a._light.position.z);var f=Math.atan2(a._light.position.x,a._light.position.z);c=Math.asin(a._light.position.y/c);var e=b*Math.cos(c);
b=e*Math.cos(f);f=e*Math.sin(f);c=e*Math.tan(c);a._light.position.x=f;a._light.position.y=c;a._light.position.z=b;a.render();a._guiLightParam.posx=a._light.position.x;a._guiLightParam.posy=a._light.position.z;a._guiLightParam.posz=a._light.position.y}).listen();b.add(this._guiLightParam,"rotatexy",0,360).onChange(function(b){b=b*Math.PI/180;var c=Math.sqrt(Math.pow(a._light.position.x,2)+Math.pow(a._light.position.z,2));a._light.position.z=c*Math.cos(b);a._light.position.x=c*Math.sin(b);a.render();
a._guiLightParam.posx=a._light.position.z;a._guiLightParam.posy=a._light.position.x}).listen();b.add(this._guiLightParam,"exportLight");b=this._gui.addFolder(lang.viewer_gui_fog);this._guiFogParams={color:a._fog.color.getHex(),density:a._fog.density,enabled:a.objects_props.fog.enabled};b.addColor(this._guiFogParams,"color").onChange(function(b){a._fog.color.setHex(b);a.render()});b.add(this._guiFogParams,"density",1E-5,.0025).onChange(function(b){a._fog.density=b;a.render()});b.add(this._guiFogParams,
"enabled").onChange(function(b){a._scene.fog=b?a._fog:null;a.animate_frame()});b=this._gui.addFolder(lang.viewer_gui_camera);this._guiCameraParams={fov:a._three_camera.fov,far:a._three_camera.far,zoom:a._three_camera.zoom,maxdistance:a._controls.maxDistance,maxpolarangle:a._controls.maxPolarAngle,posx:a._three_camera.position.z,posy:a._three_camera.position.x,posz:a._three_camera.position.y};b.add(this._guiCameraParams,"fov",1,179).onChange(function(b){a._three_camera.fov=b;a._three_camera.updateProjectionMatrix();
a.animate_frame()});b.add(this._guiCameraParams,"far",100,1E4).onChange(function(b){a._three_camera.far=b;a._three_camera.updateProjectionMatrix();a.animate_frame()});b.add(this._guiCameraParams,"zoom",.1,10).onChange(function(b){a._three_camera.zoom=b;a._three_camera.updateProjectionMatrix();a.animate_frame()});b.add(this._guiCameraParams,"maxdistance",100,5*a.worldsize.diagl).onChange(function(b){a._controls.maxDistance=b;a.animate_frame()});b.add(this._guiCameraParams,"maxpolarangle",0,Math.PI).onChange(function(b){a._controls.maxPolarAngle=
b;a.animate_frame()});b.add(this._guiCameraParams,"posx",-a.objects_props.camera.bounds.x*a.worldsize.x,a.objects_props.camera.bounds.x*a.worldsize.x).onChange(function(b){a._three_camera.position.z=b;a.objects_props.camera.target.x=b*a.objects_props.camera.radius;a._set_camera_target();a.animate_frame()}).listen();b.add(this._guiCameraParams,"posy",-a.objects_props.camera.bounds.y*a.worldsize.y,a.objects_props.camera.bounds.y*a.worldsize.y).onChange(function(b){a._three_camera.position.x=b;a.objects_props.camera.target.y=
b*a.objects_props.camera.radius;a._set_camera_target();a.animate_frame()}).listen();b.add(this._guiCameraParams,"posz",-a.objects_props.camera.bounds.z*a.worldsize.z,a.objects_props.camera.bounds.z*a.worldsize.z).onChange(function(b){a._three_camera.position.y=b;a.objects_props.camera.target.z=b*a.objects_props.camera.radius;a._set_camera_target();a.animate_frame()}).listen();$("#"+this._guiID).append(this._gui.domElement);this._threejs_helpers.guistartclosed&&this._gui.close()};this._destroy_gui=
function(){not_null_undf(a._gui)&&(a._gui.destroy(),a._gui=null,$("#"+a._guiID).empty())};this.toggle_fps_meter=function(){is_null_undf(a._helperInstances.fpsmeter)?app_library_manager.import_async_library(app_library_manager.lib.STATS,function(){var b=new Stats;a._canvasParent.append(b.dom);requestAnimationFrame(function d(){b.update();requestAnimationFrame(d)});a._helperInstances.fpsmeter=b}):(a._helperInstances.fpsmeter.dom.remove(),a._helperInstances.fpsmeter=null)};this._draw_helpers=function(){if(this._threejs_helpers.axis){if(is_null_undf(this._helperInstances.axis)){var b=
new THREE.AxesHelper(Math.min(a.worldsize.x,a.worldsize.y,a.worldsize.z)*a._threejs_helpers.axissize);a._add_mesh_to_scene(b,this._globals.helper,!1);this._helperInstances.axis=b}}else not_null_undf(this._helperInstances.axis)&&a._scene.remove(this._helperInstances.axis),this._helperInstances.axis=null;if(this._threejs_helpers.planes){if(is_null_undf(this._helperInstances.planes)){b=[];var c=new THREE.MeshBasicMaterial({color:a._threejs_helpers.planecolorx,opacity:a._threejs_helpers.planeopacity}),
d=new THREE.MeshBasicMaterial({color:a._threejs_helpers.planecolory,opacity:a._threejs_helpers.planeopacity}),f=new THREE.MeshBasicMaterial({color:a._threejs_helpers.planecolorz,opacity:a._threejs_helpers.planeopacity});c.wireframe=!0;c.aoMapIntensity=a._threejs_helpers.planeopacity;d.wireframe=!0;d.aoMapIntensity=a._threejs_helpers.planeopacity;f.wireframe=!0;f.aoMapIntensity=a._threejs_helpers.planeopacity;var e=new THREE.Geometry;e.vertices.push(this._new_three_point(this.worldsize.x,0,-this.worldsize.z),
this._new_three_point(-this.worldsize.x,0,-this.worldsize.z),this._new_three_point(-this.worldsize.x,0,this.worldsize.z),this._new_three_point(this.worldsize.x,0,this.worldsize.z));e.faces.push(new THREE.Face3(0,1,2));e.faces.push(new THREE.Face3(0,2,3));c=new THREE.Mesh(e,c);c.position.y=0;a._add_mesh_to_scene(c,this._globals.helper,!1);b.push(c);e=new THREE.Geometry;e.vertices.push(this._new_three_point(0,-this.worldsize.y,-this.worldsize.z),this._new_three_point(0,this.worldsize.y,-this.worldsize.z),
this._new_three_point(0,this.worldsize.y,this.worldsize.z),this._new_three_point(0,-this.worldsize.y,this.worldsize.z));e.faces.push(new THREE.Face3(0,1,2));e.faces.push(new THREE.Face3(0,2,3));c=new THREE.Mesh(e,d);c.position.y=0;a._add_mesh_to_scene(c,this._globals.helper,!1);b.push(c);e=new THREE.Geometry;e.vertices.push(this._new_three_point(this.worldsize.x,this.worldsize.y,0),this._new_three_point(-this.worldsize.x,this.worldsize.y,0),this._new_three_point(-this.worldsize.x,-this.worldsize.y,
0),this._new_three_point(this.worldsize.x,-this.worldsize.y,0));e.faces.push(new THREE.Face3(0,1,2));e.faces.push(new THREE.Face3(0,2,3));c=new THREE.Mesh(e,f);c.position.y=0;a._add_mesh_to_scene(c,this._globals.helper,!1);b.push(c);this._helperInstances.planes=b}}else{if(not_null_undf(this._helperInstances.planes))for(b=this._helperInstances.planes,d=0;d<b.length;d+=1)this._scene.remove(b[d]);this._helperInstances.planes=null}this._threejs_helpers.grid?is_null_undf(this._helperInstances.grid)&&(b=
new THREE.GridHelper(2*Math.max(this.worldsize.x,this.worldsize.y),Math.floor(2/this._threejs_helpers.griddist)),b.position.y=0,b.material.opacity=.5,b.material.transparent=!0,a._add_mesh_to_scene(b,this._globals.helper,!1),this._helperInstances.grid=b):(not_null_undf(this._helperInstances.grid)&&this._scene.remove(this._helperInstances.grid),this._helperInstances.grid=null);if(this._threejs_helpers.worldlimits){if(is_null_undf(this._helperInstances.worldlimits)){b=new THREE.MeshBasicMaterial({color:a._threejs_helpers.worldlimitscolor,
opacity:a._threejs_helpers.planeopacity});b.wireframe=!0;b.aoMapIntensity=.5;d=new THREE.Geometry;d.vertices.push(this._new_three_point(this.worldsize.x,-this.worldsize.y,-this.worldsize.z),this._new_three_point(this.worldsize.x,this.worldsize.y,-this.worldsize.z),this._new_three_point(this.worldsize.x,this.worldsize.y,this.worldsize.z),this._new_three_point(this.worldsize.x,-this.worldsize.y,this.worldsize.z),this._new_three_point(this.worldsize.x,this.worldsize.y,-this.worldsize.z),this._new_three_point(-this.worldsize.x,
this.worldsize.y,-this.worldsize.z),this._new_three_point(-this.worldsize.x,this.worldsize.y,this.worldsize.z),this._new_three_point(this.worldsize.x,this.worldsize.y,this.worldsize.z),this._new_three_point(-this.worldsize.x,-this.worldsize.y,-this.worldsize.z),this._new_three_point(-this.worldsize.x,this.worldsize.y,-this.worldsize.z),this._new_three_point(-this.worldsize.x,this.worldsize.y,this.worldsize.z),this._new_three_point(-this.worldsize.x,-this.worldsize.y,this.worldsize.z),this._new_three_point(this.worldsize.x,
-this.worldsize.y,-this.worldsize.z),this._new_three_point(-this.worldsize.x,-this.worldsize.y,-this.worldsize.z),this._new_three_point(-this.worldsize.x,-this.worldsize.y,this.worldsize.z),this._new_three_point(this.worldsize.x,-this.worldsize.y,this.worldsize.z),this._new_three_point(this.worldsize.x,-this.worldsize.y,this.worldsize.z),this._new_three_point(this.worldsize.x,this.worldsize.y,this.worldsize.z),this._new_three_point(-this.worldsize.x,this.worldsize.y,this.worldsize.z),this._new_three_point(-this.worldsize.x,
-this.worldsize.y,this.worldsize.z));for(f=0;4>=f;f+=1)d.faces.push(new THREE.Face3(4*f,4*f+1,4*f+2)),d.faces.push(new THREE.Face3(4*f,4*f+2,4*f+3));b=new THREE.Mesh(d,b);b.position.y=0;a._add_mesh_to_scene(b,this._globals.helper,!1);this._helperInstances.worldlimits=b}}else not_null_undf(this._helperInstances.worldlimits)&&this._scene.remove(this._helperInstances.worldlimits),this._helperInstances.worldlimits=null;if(this._threejs_helpers.cameratarget){if(is_null_undf(this._helperInstances.cameratarget)){b=
new THREE.SphereGeometry(this.objects_props.camera.raycollidedist,16,8);d=new THREE.MeshBasicMaterial({color:a._threejs_helpers.cameratargetcolor,transparent:!0,wireframe:!0});var g=new THREE.Mesh(b,d);b=function(){g.position.x=a.objects_props.camera.target.y;g.position.y=a.objects_props.camera.target.z;g.position.z=a.objects_props.camera.target.x};b();a._add_mesh_to_scene(g,this._globals.helper,!1);this._helpersUpdate.push({update:b});this._helperInstances.cameratarget={obj:g,update:this._helpersUpdate.length-
1}}}else not_null_undf(this._helperInstances.cameratarget)&&(this._helpersUpdate.splice(this._helperInstances.cameratarget.update,1),this._scene.remove(this._helperInstances.cameratarget.obj)),this._helperInstances.cameratarget=null};this._new_three_point=function(a,c,d){return new THREE.Vector3(c,d,a)};this._create_contour=function(a,c){c=new THREE.LineBasicMaterial({color:c});return new THREE.LineSegments(a,c)};this._add_mesh_to_scene=function(b,c,d,f,e){b.name=c;is_null_undf(f)&&(f=!1);is_null_undf(e)&&
(e=!1);b.castShadow=f;b.receiveShadow=e;a._scene.add(b);d&&a._add_to_collidable(b)};this._add_to_collidable=function(a){this._collaidableMeshes.push(a)};this._remove_mesh_from_scene=function(b){if(!is_null_undf(b)){a._scene.remove(b);for(var c=0;c<a._collaidableMeshes.length;c+=1)if(a._collaidableMeshes[c]===b){a._collaidableMeshes.splice(c,1);break}}};this.get_canvas_parent=function(){return this._canvasParent};this.get_camera=function(){return this._three_camera};this.get_scene=function(){return this._scene};
this.get_raycaster=function(){return this._raycaster};this.delete_last_volume=function(){not_null_undf(a._volume_meshes.volume)&&(a._remove_mesh_from_scene(a._volume_meshes.volume),this.objects_props.tooltip.mode.group.removeContainer(this._globals.volume));a._volume_meshes.volume=null;a._remove_mesh_from_scene(a._volume_meshes.helper);a._volume_meshes.helper=null;a._remove_mesh_from_scene(a._volume_meshes.contourmajor);a._volume_meshes.contourmajor=null;for(var b=0;b<a._volume_meshes.contourminor.length;b+=
1)a._remove_mesh_from_scene(a._volume_meshes.contourminor[b]);0<a._volume_meshes.contourminor.length&&(a._volume_meshes.contourminor=[]);app_console.info(lang.reset_view);a.stop_animate()};this._draw_volume=function(b){a._volume=b;app_console.info(lang.load_view);b.scale(1,this.worldsize.x,this.worldsize.y,this.worldsize.z);var c=new THREE.Geometry,d=[],f=[];b=b.get_faces();for(var e=0;e<b.length;e+=1)this._draw_face(b[e],c,d),f.push(e);a._volume_meshes.volume=new THREE.Mesh(c,d);this.objects_props.tooltip.mode.group.addContainer(this._globals.volume,
f);this._add_mesh_to_scene(a._volume_meshes.volume,this._globals.volume,!0,!1,!1);this._threejs_helpers.normals&&(d=new THREE.FaceNormalsHelper(a._volume_meshes.volume,.1*Math.min(this.worldsize.x,this.worldsize.x,this.worldsize.z),this._threejs_helpers.normalcolor,1),a._volume_meshes.helper=d,this._add_mesh_to_scene(d,this._globals.normals,!1));a.palette.contour_major&&(c=new THREE.EdgesGeometry(c),d=new THREE.LineBasicMaterial({color:this.palette.contour_major_color}),d.opacity=this.palette.contour_major_opacity,
a._volume_meshes.contourmajor=new THREE.LineSegments(c,d),this._add_mesh_to_scene(a._volume_meshes.contourmajor,this._globals.contour,!1));this.render()};this._draw_face=function(b,c,d){var f=b.generate_geometry(),e=new THREE.MeshPhongMaterial({bumpScale:.3,color:a.palette.face_color_unplayed,displacementScale:.3,emissive:a.palette.face_unhover_unplayed,shininess:a.palette.face_shininess_unplayed,specular:a.palette.face_specular});b.is_enabled()||(e.color=a.palette.face_color_played,e.emissive=a.palette.face_unhover_played,
e.shininess=a.palette.face_shininess_played);var g=new THREE.Mesh(f,e);g.updateMatrix();for(var l=g.geometry.faces,h=0;h<l.length;h+=1)g.geometry.faces[h].materialIndex=0;c.merge(g.geometry,g.matrix,d.length);d.push(e);b.set_mesh(g);b.place_image(this);b.is_enabled()&&a.palette.contour_minor&&(b=new THREE.EdgesGeometry(f),b=this._create_contour(b,this.palette.contour_minor_color),b.material.opacity=this.palette.contour_minor_opacity,b.position.y=0,b.material.transparent=!1,this._add_mesh_to_scene(b,
this._globals.contour,!1),a._volume_meshes.contourminor.push(b))};this.init=function(b){a.id=b;a._canvasParent=$(b);a._init_three();a._init_world_objects();a._init_tooltip();a.focus()};this.new=function(b){this.delete_last_volume();is_null_undf(b)||(this._load_textures(),this._draw_volume(b),a.init_animate())}};
