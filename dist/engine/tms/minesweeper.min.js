/*
 MIT
*/
function Minesweeper(){this._volume=null;this._last_click={id:"",time:new Date};this._gameover=!1;this._game_status={flags:0,mines:0,played:0,questions:0,total:0};this._timer={dom:$("#game-time-counter"),init:null,timer:new easytimer.Timer};this._dom={facecount:$("#game-ui-face-counter"),flagcount:$("#game-ui-flag-counter"),menubutton:$("#game-ui-button-menu"),minecount:$("#game-ui-mine-counter"),questioncount:$("#game-ui-question-counter"),resetbutton:$("#game-ui-button-reset"),scoreboard_container:$("#game-scoreboard-container"),
scoreboard_content:$("#game-scoreboard-content"),scoreboard_header:$("#game-scoreboard-header"),scoreboard_name:$("#game-scoreboard-name"),scoreboard_title:$("#game-scoreboard-title"),viewer:$("#viewer")};this._user={location:"",name:"",time:0};this._generator={id:"",mines:0,name:"",type_id:0};this._check_size={enabled:!0,height:520,opened:!1,width:640};this._last_downloaded_score="";this._is_playing=this._reset=!1;var a=this;this.new=function(b,c,d,f,k){var g=b.get_total_faces(!0);c=Math.max(0,Math.min(c,
g-1));a._generator.mines=c;1>c&&(c*=g);if(0===g||0===c||c>g)return!1;for(var e=b.get_faces(),h=0,n=[],l=0;l<g;l+=1)n.push(l);for(l=0;l<c;l+=1){var m=get_random_int(0,n.length-1);!e[m].has_bomb()&&e[m].is_enabled()?(e[m].place_bomb(),n.splice(m,1),h+=1):--l}c=round_number(100*h/g,1);isNaN(c)&&(c=0);app_console.info(lang.mines_placed.format(h,c));for(c=0;c<g;c+=1)e[c].has_bomb()||e[c].set_bomb_count(e[c].get_bomb_count());a._gameover=!1;a._is_playing=!0;a._game_status.total=g;a._game_status.played=
0;a._game_status.flags=0;a._game_status.questions=0;a._game_status.mines=h;a._volume=b;a._generator.id=md5(md5(d)+md5(h));a._generator.name=f;a._generator.type_id=k;return!0};this.play=function(b,c,d){if(!is_null_undf(b)&&!a._gameover){var f=new Date,k=get_seconds_between(f,this._last_click.time);b.is_played()&&this._last_click.id===b.get_id()&&.2>k&&c&&0!==b.get_bomb_count()&&(app_console.info(lang.mines_detected_double_lclick.format(k)),this._clear_zeros(b,d,!0),a._update_counters(),this._check_win());
this._last_click.id=b.get_id();this._last_click.time=f;if(!b.is_played()){if(c){if(b.has_flag()){app_sound.play(app_sound.sound.WRONG);return}b.has_question()&&(b.place_flag(),--a._game_status.questions,--a._game_status.played);b.play(d);b.place_image(d);app_sound.play(app_sound.sound.CLICK);a._game_status.played+=1;if(this._check_bomb(b,d))return;0===b.get_bomb_count()&&this._clear_zeros(b,d,!1)}else{if(.15>k)return;b.place_flag();b.place_image(d);b.has_flag()?(app_sound.play(app_sound.sound.FLAG),
a._game_status.flags+=1,a._game_status.played+=1):b.has_question()?(app_sound.play(app_sound.sound.UNFLAG),--a._game_status.flags,a._game_status.questions+=1):(--a._game_status.questions,--a._game_status.played,app_sound.play(app_sound.sound.CLICK))}d.render();a._update_counters();this._check_win()}}};this._clear_zeros=function(b,c,d){b=b.get_target_faces();for(var f=0;f<b.length;f+=1)if(!(!b[f].is_enabled()||b[f].is_played()||b[f].has_bomb()&&!d||b[f].has_flag()||b[f].has_question())){b[f].play(c);
b[f].place_image(c);a._game_status.played+=1;if(this._check_bomb(b[f],c))break;0===b[f].get_bomb_count()&&this._clear_zeros(b[f],c,!0)}};this._check_bomb=function(b,c){return b.has_bomb()?(a._gameover=!0,app_console.info(lang.game_over),a._timer.timer.stop(),this._set_text_color("#ff1111"),this._explotion_effect([b],c,0),app_sound.play(app_sound.sound.GAMEOVER),setTimeout(function(){a._explotion_secondary_effect([b],c,0)},300),!0):!1};this._check_win=function(){if(a._game_status.played===a._game_status.total||
a._game_status.played+a._game_status.mines-a._game_status.flags-a._game_status.questions===a._game_status.total){app_console.info(lang.game_checking_win_condition);for(var b=0,c=a._volume.get_faces(),d=0;d<c.length;d+=1)!c[d].is_enabled()||c[d].is_played()&&c[d].has_bomb()||!c[d].is_played()&&!c[d].has_bomb()||(b+=1);b===a._game_status.total&&(b=get_seconds_from(this._timer.init),a._user.time=b,a._timer.timer.stop(),a._gameover=!0,a._set_text_color("#3dff4d"),app_console.info(lang.game_finished.format(b)),
app_sound.play(app_sound.sound.GAMEWIN),a._request_username())}};this._explotion_effect=function(b,c,d){for(var f=[],k=[],g=0;g<b.length;g+=1){b[g].explode(c);for(var e=b[g].get_target_faces(),h=0;h<e.length;h+=1)e[h].has_exploded()||k.includes(e[h].get_id())||(f.push(e[h]),k.push(e[h].get_id()))}0!==f.length&&a._is_playing&&setTimeout(function(){a._explotion_effect(f,c,d+1)},Math.floor(30*Math.pow(d+1,.2)))};this._explotion_secondary_effect=function(b,c,d){for(var f=[],k=[],g=0;g<b.length;g+=1){b[g].explode_secondary(c);
for(var e=b[g].get_target_faces(),h=0;h<e.length;h+=1)e[h].has_exploded_secondary()||k.includes(e[h].get_id())||(f.push(e[h]),k.push(e[h].get_id()))}0!==f.length&&a._is_playing?setTimeout(function(){a._explotion_secondary_effect(f,c,d+1)},Math.floor(80*Math.pow(d+1,.1))):a._new_game_after_lose()};this._set_text_color=function(b){a._dom.facecount.css("color",b);a._dom.flagcount.css("color",b);a._dom.minecount.css("color",b);a._dom.questioncount.css("color",b);a._timer.dom.css("color",b)};this.reset_game_ui=
function(){this._set_text_color("#ffffff");a._timer.dom.html("00:00:00");this._timer.timer.stop();this._timer.timer.removeEventListener("secondsUpdated");this._dom.menubutton.off("click");this._dom.resetbutton.off("click");app_dom.window.off("resize.scoreboard");a._check_size.enabled&&app_dom.window.off("resize.checksize");this._dom.viewer.hide();app_console.info(lang.reset_ui)};this.new_game_ui=function(b){this.reset_game_ui();app_console.info(lang.load_ui);this._timer.init=new Date;this._timer.timer.reset();
this._timer.timer.start();this._timer.timer.addEventListener("secondsUpdated",function(){a._timer.dom.html(a._timer.timer.getTimeValues().toString())});this._dom.menubutton.html('<i class="fas fa-home"></i> '+lang.game_back_to_menu);this._dom.resetbutton.html('<i class="fas fa-redo-alt"></i> '+lang.game_reset);this._dom.menubutton.on("click",function(){var b=function(){a._is_playing=!1;app_tms.load_menu()};app_sound.play(app_sound.sound.BUTTON);0===a._game_status.played||a._gameover?b():app_dialog.confirm(lang.leave_game_title,
lang.leave_game_confirm,{confirm:b,confirmButtonClass:app_dialog.options.buttons.BLUE,icon:"fas fa-home",size:app_dialog.options.size.SMALL})});this._dom.resetbutton.on("click",function(){var b=function(){a._reset=!0;app_tms.new()};app_sound.play(app_sound.sound.BUTTON);0===a._game_status.played||a._gameover?b():app_dialog.confirm(lang.reset_game_title,lang.reset_game_confirm,{confirm:b,confirmButtonClass:app_dialog.options.buttons.DANGER,icon:"fas fa-exclamation-triangle",size:app_dialog.options.size.SMALL})});
a._update_counters();b&&a._load_score(!0);a._check_size.opened=!1;a._check_size.enabled&&(app_dom.window.on("resize.checksize",a._check_window_size),a._check_window_size());this._dom.viewer.show();a._scoreboard_setup();a._reset=!1};this._check_window_size=function(){var b=app_dom.window.outerWidth(),c=app_dom.window.outerHeight();b>=a._check_size.width&&c>=a._check_size.height?(a._check_size.opened&&app_dialog.close_last(),a._check_size.opened=!1):a._check_size.opened||(a._check_size.opened=!0,app_dialog.confirm(lang.check_window_size_title,
lang.check_window_size_info.format(round_number(b),round_number(c),round_number(a._check_size.width),round_number(a._check_size.height)),{cancelText:null,confirm:function(){a._check_window_size()},confirmButtonClass:app_dialog.options.buttons.DANGER,confirmText:lang.answer_ok,icon:"fas fa-desktop",size:app_dialog.options.size.NORMAL}))};this._load_score=function(b){b&&a._scoreboard_setup();setTimeout(function(){a._get_score()},1E3)};this._update_counters=function(){var b=round_number(100*a._game_status.played/
a._game_status.total,1);isNaN(b)&&(b=0);a._dom.facecount.html("{0}/{1} ({2}%)".format(a._game_status.played,a._game_status.total,b));a._dom.flagcount.html(a._game_status.flags);a._dom.minecount.html(a._game_status.mines);a._dom.questioncount.html(a._game_status.questions)};this._request_username=function(){if(a._is_playing){var b=generateID(),c=sessionCookie.username;is_null_undf(c)&&(c="");app_dialog.form(lang.game_won_title,'{2}.<br><br><form action="" class="formName"><div class="form-group"><label for="{0}">{1}:</label><input type="text" class="form-control" id="{0}" minlength="4" maxlength="20" value="{4}" required aria-required="true" placeholder="{5}" aria-placeholder="{5}" {3}></div></form>'.format(b,
lang.game_won_name,lang.game_won_content.format(round_number(a._user.time,10>a._user.time?3:2)),""===c?"autofocus":"",c,lang.game_won_placeholder),function(){var c=a._sanitize_text($("#"+b).val());4<=c.length&&20>=c.length&&(sessionCookie.username=c,update_session_cookie(),a._submit_score(c))},a._new_game_after_win,{cancelText:lang.dialog_form_cancel,icon:"fas fa-trophy",submitText:lang.dialog_form_send})}};this._sanitize_text=function(a){a=a.toString();a=a.replace(/[^a-z0-9\u00e1\u00e9\u00ed\u00f3\u00fa\u00f1\u00fc .,_-]/gim,
"");return a.trim()};this._submit_score=function(b){app_library_manager.import_async_library(app_library_manager.lib.DBIP,function(){a._user.name=b;dbip.getVisitorInfo().then(function(b){a._user.location=b.countryCode.toLowerCase();a._push_server()}).catch(function(){NotificationJS.error(lang.score_error_location);a._user.location="none";setTimeout(a._push_server,500)})})};this._push_server=function(){var b=$.ajax({crossOrigin:cfg_ajax_cors,data:"m=upload&id={0}&u={1}&c={2}&t={3}&g={4}".format(a._generator.id,
a._user.name,a._user.location,a._user.time,a._generator.type_id),timeout:cfg_href_ajax_timeout,type:"get",url:cfg_href_score});b.done(function(b){try{var c=JSON.parse(b);if(-1===Object.keys(c).indexOf("error")){a._load_score(!1);return}NotificationJS.error(lang.score_error_submit)}catch(f){app_console.exception(f)}finally{}app_console.exception(b)});b.fail(function(a,b,f){NotificationJS.error(lang.score_error_submit)});a._new_game_after_win()};this._new_game_after_win=function(){a._is_playing&&setTimeout(function(){app_dialog.confirm(lang.game_won_title,
lang.start_new_game,{confirm:function(){a._reset=!0;app_tms.new()},backgroundDismiss:"cancel",confirmButtonClass:app_dialog.options.buttons.SUCCESS,escapeCancelKey:!0,icon:"fas fa-trophy",size:app_dialog.options.size.SMALL})},400)};this._new_game_after_lose=function(){a._is_playing&&setTimeout(function(){app_dialog.confirm(lang.game_over,lang.start_new_game,{confirm:function(){a._reset=!0;app_tms.new()},backgroundDismiss:"cancel",confirmButtonClass:app_dialog.options.buttons.DANGER,escapeCancelKey:!0,
icon:"fas fa-bomb",size:app_dialog.options.size.SMALL})},400)};this._get_score=function(){var b=$.ajax({crossOrigin:cfg_ajax_cors,data:"m=get&id={0}&g={1}".format(a._generator.id,a._generator.type_id),timeout:cfg_href_ajax_timeout,type:"get",url:cfg_href_score});b.done(function(b){try{var c=JSON.parse(b);if(-1===Object.keys(c).indexOf("error")){a._write_scores(c);return}}catch(f){app_console.exception(f)}finally{}NotificationJS.error(lang.score_error_get);app_console.error(b);a._write_scores(null)});
b.fail(function(b,d,f){NotificationJS.error(lang.score_error_get);a._write_scores(null)})};this._write_scores=function(b){var c=md5(b);if(c!==a._last_downloaded_score){a._last_downloaded_score=c;a._dom.scoreboard_content.empty();if(not_null_undf(b)){for(var d=c=0;d<b.length;d+=1)a._write_user_scoreboard(b[d].user,d+1,b[d].country,b[d].date,b[d].time)&&(c+=1);0===c&&a._dom.scoreboard_content.html('<div class="game-scoreboard-empty">{0} <i class="fas fa-smile-wink"></i></div>'.format(lang.scoreboard_empty,
a._get_scoreboard_height()))}else a._dom.scoreboard_content.html('<div class="game-scoreboard-empty"><i class="fas fa-exclamation-triangle"></i> {0}</div>'.format(lang.server_error));a._center_scoreboard()}};this._scoreboard_setup=function(){a._dom.scoreboard_content.animate({scrollTop:0},400);if(!a._reset){a._last_downloaded_score="";a._dom.scoreboard_content.empty();a._dom.scoreboard_title.html(lang.scoreboard_title);var b=1>a._generator.mines?round_number(100*a._generator.mines,2).toString()+"%":
round_number(a._generator.mines,0).toString();b="0"!==b&&"0%"!==b?"{0} ({1})".format(a._generator.name,b):"";a._dom.scoreboard_name.html(b);app_dom.window.on("resize.scoreboard",a._center_scoreboard);a._center_scoreboard();a._dom.scoreboard_content.html('<div class="game-scoreboard-loading" style="line-height: {0}px;"><i class="fa fa-spinner fa-spin fa-3x fa-fw"></i></div>'.format(a._get_scoreboard_height()))}};this._center_scoreboard=function(){a._dom.scoreboard_content.css("height",a._get_scoreboard_height());
var b=a._dom.scoreboard_content.find(".game-scoreboard-empty");is_null_undf(b)||0===b.length||(b.css("line-height",""),b.css("padding-top",a._get_scoreboard_height()/2-20+"px"))};this._get_scoreboard_height=function(){var b=a._dom.scoreboard_container.innerHeight(),c=get_element_height(a._dom.scoreboard_header);return b-c-6};this._write_user_scoreboard=function(b,c,d,f,k){var g="",e=parseFloat(k);if(isNaN(e)||0>=k)return!1;10>e&&(e=round_number(e,3),g=e.toString().padEnd(5,"0"));10<e&&(e=round_number(e,
2),g=e.toString().padEnd(5,"0"));100<e&&(e=round_number(e,1),g=e.toString().padEnd(5,"0"));1E3<e&&(e=round_number(e,0),g=e.toString());if(86400<e)return!1;d=d.toString();if(is_null_undf(d)||"null"===d||"none"===d)d="";if(""!==d){k="";for(e=0;e<country_list.length;e+=1)if(country_list[e].code.toLowerCase()===d){k=country_list[e].name;break}d='<div class="game-scoreboard-userdata-img"><img src="resources/flags/{0}.png" alt="" title="{1}" /></div>'.format(d,k)}else if("none"===d||"null"===d)d='<div class="game-scoreboard-userdata-img-null"></div>'.format();
f=date_format(new Date(f),cfg_date_format_public_d);a._dom.scoreboard_content.append('<div class="game-scoreboard-entry"><div class="game-scoreboard-user"><div class="game-scoreboard-username">{0}</div><div class="game-scoreboard-userdata"><div class="game-scoreboard-userdata-position">#{1}</div><div class="game-scoreboard-userdata-date">{3}</div>{2}</div></div><div class="game-scoreboard-time">{4}</div></div>'.format(b,c,d,f,g));return!0}};
