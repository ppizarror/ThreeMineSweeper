"use strict";var data,view,doop=require("jsdoc/util/doop"),fs=require("jsdoc/fs"),helper=require("jsdoc/util/templateHelper"),logger=require("jsdoc/util/logger"),path=require("jsdoc/path"),taffy=require("taffydb").taffy,template=require("jsdoc/template"),util=require("util"),htmlsafe=helper.htmlsafe,linkto=helper.linkto,resolveAuthorLinks=helper.resolveAuthorLinks,scopeToPunc=helper.scopeToPunc,hasOwnProp=Object.prototype.hasOwnProperty,outdir=path.normalize(env.opts.destination);function find(e){return helper.find(data,e)}function tutoriallink(e){return helper.toTutorial(e,null,{tag:"em",classname:"disabled",prefix:"Tutorial: "})}function getAncestorLinks(e){return helper.getAncestorLinks(data,e)}function hashToLink(e,n){if(!/^(#.+)/.test(n))return n;var t=helper.createLink(e);return'<a href="'+(t=t.replace(/(#.+|$)/,n))+'">'+n+"</a>"}function needsSignature(e){var n=!1;if("function"===e.kind||"class"===e.kind)n=!0;else if("typedef"===e.kind&&e.type&&e.type.names&&e.type.names.length)for(var t=0,a=e.type.names.length;t<a;t++)if("function"===e.type.names[t].toLowerCase()){n=!0;break}return n}function getSignatureAttributes(e){var n=[];return e.optional&&n.push("opt"),!0===e.nullable?n.push("nullable"):!1===e.nullable&&n.push("non-null"),n}function updateItemName(e){var n=getSignatureAttributes(e),t=e.name||"";return e.variable&&(t="&hellip;"+t),n&&n.length&&(t=util.format('%s<span class="signature-attributes">%s</span>',t,n.join(", "))),t}function addParamAttributes(e){return e.filter(function(e){return e.name&&-1===e.name.indexOf(".")}).map(updateItemName)}function buildItemTypeStrings(e){var n=[];return e&&e.type&&e.type.names&&e.type.names.forEach(function(e){n.push(linkto(e,htmlsafe(e)))}),n}function buildAttribsString(e){var n="";return e&&e.length&&(n=htmlsafe(util.format("(%s) ",e.join(", ")))),n}function addNonParamAttributes(e){var n=[];return e.forEach(function(e){n=n.concat(buildItemTypeStrings(e))}),n}function addSignatureParams(e){var n=e.params?addParamAttributes(e.params):[];e.signature=util.format("%s(%s)",e.signature||"",n.join(", "))}function addSignatureReturns(e){var n=[],t="",a=[],r="";e.returns&&(e.returns.forEach(function(e){helper.getAttribs(e).forEach(function(e){-1===n.indexOf(e)&&n.push(e)})}),t=buildAttribsString(n)),e.returns&&(a=addNonParamAttributes(e.returns)),a.length&&(r=util.format(" &rarr; %s{%s}",t,a.join("|"))),e.signature='<span class="signature">'+(e.signature||"")+'</span><span class="type-signature">'+r+"</span>"}function addSignatureTypes(e){var n=e.type?buildItemTypeStrings(e):[];e.signature=(e.signature||"")+'<span class="type-signature">'+(n.length?" :"+n.join("|"):"")+"</span>"}function addAttribs(e){var n=buildAttribsString(helper.getAttribs(e));e.attribs=util.format('<span class="type-signature">%s</span>',n)}function shortenPaths(e,n){return Object.keys(e).forEach(function(t){e[t].shortened=e[t].resolved.replace(n,"").replace(/\\/g,"/")}),e}function getPathFromDoclet(e){return e.meta?e.meta.path&&"null"!==e.meta.path?path.join(e.meta.path,e.meta.filename):e.meta.filename:null}function generate(e,n,t,a,r){r=!1!==r;var i={type:e,title:n,docs:t},l=path.join(outdir,a),o=view.render("container.tmpl",i);r&&(o=helper.resolveLinks(o)),fs.writeFileSync(l,o,"utf8")}function generateSourceFiles(e,n){n=n||"utf8",Object.keys(e).forEach(function(t){var a,r=helper.getUniqueFilename(e[t].shortened);helper.registerLink(e[t].shortened,r);try{a={kind:"source",code:helper.htmlsafe(fs.readFileSync(e[t].resolved,n))}}catch(e){logger.error("Error while generating source file %s: %s",t,e.message)}generate("Source",e[t].shortened,[a],r,!1)})}function attachModuleSymbols(e,n){var t={};return e.forEach(function(e){t[e.longname]=t[e.longname]||[],t[e.longname].push(e)}),n.map(function(e){t[e.longname]&&(e.modules=t[e.longname].filter(function(e){return e.description||"class"===e.kind}).map(function(e){return"class"!==(e=doop(e)).kind&&"function"!==e.kind||(e.name=e.name.replace("module:",'(require("')+'"))'),e}))})}function buildNav(e){var n=[],t={};return n.push(buildNavLink("home",'<a href="index.html">Home</a>')),n=(n=(n=(n=(n=(n=(n=(n=n.concat(buildMemberNav(e.tutorials,"Tutorials",{},linktoTutorial))).concat(buildMemberNav(e.classes,"Classes",t,linkto))).concat(buildMemberNav(e.modules,"Modules",{},linkto))).concat(buildMemberNav(e.externals,"Externals",t,linktoExternal))).concat(buildMemberNav(e.events,"Events",t,linkto))).concat(buildMemberNav(e.namespaces,"Namespaces",t,linkto))).concat(buildMemberNav(e.mixins,"Mixins",t,linkto))).concat(buildMemberNav(e.interfaces,"Interfaces",t,linkto)),e.globals.length&&(n.push(buildNavHeading(linkto("global","Globals"))),e.globals.forEach(function(e){"typedef"===e.kind||hasOwnProp.call(t,e.longname)||n.push(buildNavItem(buildNavType(e.kind,linkto(e.longname,e.name)))),t[e.longname]=!0})),n.join("")}function buildMemberNav(e,n,t,a){var r=[],i=env.conf.templates||{};if(i.default=i.default||{},e&&e.length){r.push(buildNavHeading(n)),e.forEach(function(e){var l,o=find({kind:"function",memberof:e.longname});find({kind:"member",memberof:e.longname});if(hasOwnProp.call(e,"longname")){if(!hasOwnProp.call(t,e.longname)){if(i.default.useLongnameInNav){if(l=e.longname,i.default.useLongnameInNav>0&&!0!==i.default.useLongnameInNav){var s=i.default.useLongnameInNav,u=e.longname.split(".").slice(-s).join(".");u!==l&&(l="..."+u)}}else l=e.name;l=l.replace(/^module:/g,""),"Tutorials"===n?r.push(buildNavItem(a(e.longname,l))):r.push(buildNavHeading(buildNavType(e.kind,a(e.longname,l)))),o.length&&o.forEach(function(e){e.inherited&&!1===i.showInheritedInNav||r.push(buildNavItem(buildNavType(e.kind,linkto(e.longname,e.name))))}),t[e.longname]=!0}}else r.push(buildNavItem(linkfoFn("",e.name)))})}return r}function linktoTutorial(e,n){return tutoriallink(n)}function linktoExternal(e,n){return linkto(e,n.replace(/(^"|"$)/g,""))}function buildNavLink(e,n){return['<li class="nav-link nav-'+e+'-link">',n,"</li>"].join("")}function buildNavHeading(e){return['<li class="nav-heading">',e,"</li>"].join("")}function buildNavItem(e){return['<li class="nav-item">',e,"</li>"].join("")}function buildNavType(e,n){return['<span class="nav-item-type type-'+e+'">',e[0].toUpperCase(),"</span>",'<span class="nav-item-name">',n,"</span>"].join("")}exports.publish=function(e,n,t){data=e;var a=env.conf.templates||{};a.default=a.default||{};var r=path.normalize(n.template);view=new template.Template(path.join(r,"tmpl"));var i=helper.getUniqueFilename("index"),l=helper.getUniqueFilename("global");helper.registerLink("global",l),view.layout=a.default.layoutFile?path.getResourcePath(path.dirname(a.default.layoutFile),path.basename(a.default.layoutFile)):"layout.tmpl",helper.setTutorials(t),(data=helper.prune(data)).sort("longname, version, since"),helper.addEventListeners(data);var o={},s=[];data().each(function(e){var n;e.attribs="",e.examples&&(e.examples=e.examples.map(function(e){var n,t;return e.match(/^\s*<caption>([\s\S]+?)<\/caption>(\s*[\n\r])([\s\S]+)$/i)&&(n=RegExp.$1,t=RegExp.$3),{caption:n||"",code:t||e}})),e.see&&e.see.forEach(function(n,t){e.see[t]=hashToLink(e,n)}),e.meta&&(n=getPathFromDoclet(e),o[n]={resolved:n,shortened:null},-1===s.indexOf(n)&&s.push(n))});var u=(find({kind:"package"})||[])[0];u&&u.name&&(outdir=path.join(outdir,u.name,u.version||"")),fs.mkPath(outdir);var c,d,m,p=path.join(r,"static");fs.ls(p,3).forEach(function(e){var n=fs.toDir(e.replace(p,outdir));fs.mkPath(n),fs.copyFileSync(e,n)}),a.default.staticFiles&&(c=a.default.staticFiles.include||a.default.staticFiles.paths||[],d=new(require("jsdoc/src/filter").Filter)(a.default.staticFiles),m=new(require("jsdoc/src/scanner").Scanner),c.forEach(function(e){m.scan([e],10,d).forEach(function(n){var t=fs.toDir(e),a=fs.toDir(n.replace(t,outdir));fs.mkPath(a),fs.copyFileSync(n,a)})})),s.length&&(o=shortenPaths(o,path.commonPrefix(s))),data().each(function(e){var n,t=helper.createLink(e);helper.registerLink(e.longname,t),e.meta&&(n=getPathFromDoclet(e),(n=o[n].shortened)&&(e.meta.shortpath=n))}),data().each(function(e){helper.longnameToUrl[e.longname].indexOf("#")>-1?e.id=helper.longnameToUrl[e.longname].split(/#/).pop():e.id=e.name,needsSignature(e)&&(addSignatureParams(e),addSignatureReturns(e),addAttribs(e))}),data().each(function(e){e.ancestors=getAncestorLinks(e),"member"===e.kind&&(addSignatureTypes(e),addAttribs(e)),"constant"===e.kind&&(addSignatureTypes(e),addAttribs(e),e.kind="member")});var f=helper.getMembers(data);f.tutorials=t.children;var h=!(!a.default||!1===a.default.outputSourceFiles);view.find=find,view.linkto=linkto,view.resolveAuthorLinks=resolveAuthorLinks,view.tutoriallink=tutoriallink,view.htmlsafe=htmlsafe,view.outputSourceFiles=h,view.nav=buildNav(f),attachModuleSymbols(find({longname:{left:"module:"}}),f.modules),h&&generateSourceFiles(o,n.encoding),f.globals.length&&generate("","Global",[{kind:"globalobj"}],l);var g=find({kind:"file"});generate("","Home",find({kind:"package"}).concat([{kind:"mainpage",readme:n.readme,longname:n.mainpagetitle?n.mainpagetitle:"Main Page"}]).concat(g),i);var v=taffy(f.classes),b=taffy(f.modules),k=taffy(f.namespaces),y=taffy(f.mixins),N=taffy(f.externals),S=taffy(f.interfaces);Object.keys(helper.longnameToUrl).forEach(function(e){var n=helper.find(b,{longname:e});n.length&&generate("Module",n[0].name,n,helper.longnameToUrl[e]);var t=helper.find(v,{longname:e});t.length&&generate("Class",t[0].name,t,helper.longnameToUrl[e]);var a=helper.find(k,{longname:e});a.length&&generate("Namespace",a[0].name,a,helper.longnameToUrl[e]);var r=helper.find(y,{longname:e});r.length&&generate("Mixin",r[0].name,r,helper.longnameToUrl[e]);var i=helper.find(N,{longname:e});i.length&&generate("External",i[0].name,i,helper.longnameToUrl[e]);var l=helper.find(S,{longname:e});l.length&&generate("Interface",l[0].name,l,helper.longnameToUrl[e])}),function e(n){n.children.forEach(function(n){var t,a,r,i,l,o;t=n.title,a=n,r=helper.tutorialToUrl(n.name),i={title:t,header:a.title,content:a.parse(),children:a.children},l=path.join(outdir,r),o=view.render("tutorial.tmpl",i),o=helper.resolveLinks(o),fs.writeFileSync(l,o,"utf8"),e(n)})}(t)};