"use strict";var data,view,template=require("jsdoc/template"),doop=require("jsdoc/util/doop"),fs=require("jsdoc/fs"),_=require("underscore"),path=require("jsdoc/path"),taffy=require("taffydb").taffy,handle=require("jsdoc/util/error").handle,helper=require("jsdoc/util/templateHelper"),moment=require("moment"),htmlsafe=helper.htmlsafe,sanitizeHtml=require("sanitize-html"),linkto=helper.linkto,resolveAuthorLinks=helper.resolveAuthorLinks,scopeToPunc=helper.scopeToPunc,hasOwnProp=Object.prototype.hasOwnProperty,conf=env.conf.templates||{},outdir=env.opts.destination,searchEnabled=!1!==conf.search,globalUrl=helper.getUniqueFilename("global"),indexUrl=helper.getUniqueFilename("index"),navOptions={includeDate:!1!==conf.includeDate,logoFile:conf.logoFile,systemName:conf.systemName||"Documentation",navType:conf.navType||"vertical",footer:conf.footer||"",copyright:conf.copyright||"",theme:conf.theme||"simplex",syntaxTheme:conf.syntaxTheme||"default",linenums:conf.linenums,collapseSymbols:conf.collapseSymbols||!1,inverseNav:conf.inverseNav,outputSourceFiles:!0===conf.outputSourceFiles,sourceRootPath:conf.sourceRootPath,disablePackagePath:conf.disablePackagePath,outputSourcePath:conf.outputSourcePath,dateFormat:conf.dateFormat,analytics:conf.analytics||null,methodHeadingReturns:!0===conf.methodHeadingReturns,sort:conf.sort,search:searchEnabled},searchableDocuments={},navigationMaster={index:{title:navOptions.systemName,link:indexUrl,members:[]},namespace:{title:"Namespaces",link:helper.getUniqueFilename("namespaces.list"),members:[]},module:{title:"Modules",link:helper.getUniqueFilename("modules.list"),members:[]},class:{title:"Classes",link:helper.getUniqueFilename("classes.list"),members:[]},mixin:{title:"Mixins",link:helper.getUniqueFilename("mixins.list"),members:[]},event:{title:"Events",link:helper.getUniqueFilename("events.list"),members:[]},interface:{title:"Interfaces",link:helper.getUniqueFilename("interfaces.list"),members:[]},tutorial:{title:"Tutorials",link:helper.getUniqueFilename("tutorials.list"),members:[]},global:{title:"Global",link:globalUrl,members:[]},external:{title:"Externals",link:helper.getUniqueFilename("externals.list"),members:[]}};function find(e){return helper.find(data,e)}function tutoriallink(e){return helper.toTutorial(e,null,{tag:"em",classname:"disabled",prefix:"Tutorial: "})}function getAncestorLinks(e){return helper.getAncestorLinks(data,e)}function hashToLink(e,n){if(!/^(#.+)/.test(n))return n;var a=helper.createLink(e);return'<a href="'+(a=a.replace(/(#.+|$)/,n))+'">'+n+"</a>"}function needsSignature(e){var n=!1;if("function"===e.kind||"class"===e.kind)n=!0;else if("typedef"===e.kind&&e.type&&e.type.names&&e.type.names.length)for(var a=0,t=e.type.names.length;a<t;a++)if("function"===e.type.names[a].toLowerCase()){n=!0;break}return n}function addSignatureParams(e){var n="optional",a=helper.getSignatureParams(e,n);e.signature=(e.signature||"")+"(";for(var t=0,l=a.length;t<l;t++){var i=a[t],r=t>0?", ":"";if(new RegExp("class=[\"|']"+n+"[\"|']").test(i)){var o=new RegExp("<span class=[\"|']"+n+"[\"|']>(.*?)<\\/span>","i");e.signature+=i.replace(o," $`["+r+"$1$']")}else e.signature+=r+i}e.signature+=")"}function addSignatureReturns(e){if(navOptions.methodHeadingReturns){var n=helper.getSignatureReturns(e);e.signature='<span class="signature">'+(e.signature||"")+'</span><span class="type-signature">'+(n.length?" &rarr; {"+n.join("|")+"}":"")+"</span>"}else e.signature=e.signature||""}function addSignatureTypes(e){var n=helper.getSignatureTypes(e);e.signature=(e.signature||"")+'<span class="type-signature">'+(n.length?" :"+n.join("|"):"")+"</span>"}function addAttribs(e){var n=helper.getAttribs(e);e.attribs='<span class="type-signature">'+htmlsafe(n.length?"<"+n.join(", ")+"> ":"")+"</span>"}function shortenPaths(e,n){return Object.keys(e).forEach(function(a){e[a].shortened=e[a].resolved.replace(n,"").replace(/\\/g,"/")}),e}function getPathFromDoclet(e){if(e.meta)return path.normalize(e.meta.path&&"null"!==e.meta.path?e.meta.path+"/"+e.meta.filename:e.meta.filename)}function searchData(e){var n=e.indexOf('<div class="container">');if(n>0){var a=e.indexOf('<div class="container">',n+2);a>0&&(n=a),e=e.slice(n)}var t=e.indexOf('<span class="copyright">');t>0&&(e=e.substring(0,t));var l=sanitizeHtml(e,{allowedTags:[],allowedAttributes:[]});return l=l.replace(/\s+/g," ")}function generate(e,n,a,t,l){l=!1!==l;var i={title:n,docs:a,docType:e},r=path.join(outdir,t),o=view.render("container.tmpl",i);l&&(o=helper.resolveLinks(o)),searchEnabled&&(searchableDocuments[t]={id:t,title:n,body:searchData(o)}),fs.writeFileSync(r,o,"utf8")}function generateSourceFiles(e){Object.keys(e).forEach(function(n){var a,t=helper.getUniqueFilename(e[n].shortened);helper.registerLink(e[n].shortened,t);try{a={kind:"source",code:helper.htmlsafe(fs.readFileSync(e[n].resolved,"utf8"))}}catch(e){handle(e)}generate("source","Source: "+e[n].shortened,[a],t,!1)})}function attachModuleSymbols(e,n){var a={};return e.forEach(function(e){a[e.longname]=a[e.longname]||[],a[e.longname].push(e)}),n.map(function(e){a[e.longname]&&(e.modules=a[e.longname].filter(function(e){return e.description||"class"===e.kind}).map(function(e){return"class"!==(e=doop(e)).kind&&"function"!==e.kind||(e.name=e.name.replace("module:",'(require("')+'"))'),e}))})}function buildNav(e){var n={},a=navigationMaster;e.modules.length&&e.modules.forEach(function(e){hasOwnProp.call(n,e.longname)||a.module.members.push(linkto(e.longname,e.longname.replace("module:",""))),n[e.longname]=!0}),e.externals.length&&e.externals.forEach(function(e){hasOwnProp.call(n,e.longname)||a.external.members.push(linkto(e.longname,e.name.replace(/(^"|"$)/g,""))),n[e.longname]=!0}),e.classes.length&&e.classes.forEach(function(e){hasOwnProp.call(n,e.longname)||a.class.members.push(linkto(e.longname,e.longname.replace("module:",""))),n[e.longname]=!0}),e.events.length&&e.events.forEach(function(e){hasOwnProp.call(n,e.longname)||a.event.members.push(linkto(e.longname,e.longname.replace("module:",""))),n[e.longname]=!0}),e.namespaces.length&&e.namespaces.forEach(function(e){hasOwnProp.call(n,e.longname)||a.namespace.members.push(linkto(e.longname,e.longname.replace("module:",""))),n[e.longname]=!0}),e.mixins.length&&e.mixins.forEach(function(e){hasOwnProp.call(n,e.longname)||a.mixin.members.push(linkto(e.longname,e.longname.replace("module:",""))),n[e.longname]=!0}),e.interfaces&&e.interfaces.length&&e.interfaces.forEach(function(e){hasOwnProp.call(n,e.longname)||a.interface.members.push(linkto(e.longname,e.longname.replace("module:",""))),n[e.longname]=!0}),e.tutorials.length&&e.tutorials.forEach(function(e){a.tutorial.members.push(tutoriallink(e.name))}),e.globals.length&&(e.globals.forEach(function(e){"typedef"===e.kind||hasOwnProp.call(n,e.longname)||a.global.members.push(linkto(e.longname,e.longname.replace("module:",""))),n[e.longname]=!0}),0===a.global.members.length&&a.global.members.push(linkto("global","Global")));var t=[];_.each(a,function(e,n){e.members.length>0&&"index"!==n&&t.push({title:e.title,link:e.link,members:e.members})}),a.topLevelNav=t}exports.publish=function(e,n,a){data=e,conf.default=conf.default||{};var t=n.template;view=new template.Template(t+"/tmpl"),helper.registerLink("global",globalUrl),view.layout=conf.default.layoutFile?path.getResourcePath(path.dirname(conf.default.layoutFile),path.basename(conf.default.layoutFile)):"layout.tmpl",helper.setTutorials(a),data=helper.prune(data);var l=void 0===navOptions.sort?n.sort:navOptions.sort;(l=!0===(l=void 0===l||l)?"longname, version, since":l)&&data.sort(l),helper.addEventListeners(data);var i={},r=[];data().each(function(e){var n;e.attribs="",e.examples&&(e.examples=e.examples.map(function(e){var n,a;return e.match(/^\s*(<p>)?<caption>([\s\S]+?)<\/caption>(\s*)([\s\S]+?)(<\/p>)?$/i)&&(n=RegExp.$2,e=RegExp.$4+(RegExp.$1?"":RegExp.$5)),(a=/{@lang (.*?)}/.exec(e))&&a[1]?(e=e.replace(a[0],""),a=a[1]):a=null,{caption:n||"",code:e,lang:a||"javascript"}})),e.see&&e.see.forEach(function(n,a){e.see[a]=hashToLink(e,n)}),e.meta&&(n=getPathFromDoclet(e),i[n]={resolved:n,shortened:null},-1===r.indexOf(n)&&r.push(n))});var o=(find({kind:"package"})||[])[0];!0!==navOptions.disablePackagePath&&o&&o.name&&(outdir=o.version?path.join(outdir,o.name,o.version):path.join(outdir,o.name)),fs.mkPath(outdir);var s,c,m,u=path.join(t,"static");if(fs.ls(u,3).forEach(function(e){var n=e.replace(u,outdir),a=fs.toDir(n);fs.mkPath(a),fs.copyFileSync(e,"",n)}),conf.default.staticFiles&&(s=conf.default.staticFiles.include||conf.default.staticFiles.paths||[],c=new(require("jsdoc/src/filter").Filter)(conf.default.staticFiles),m=new(require("jsdoc/src/scanner").Scanner),s.forEach(function(e){m.scan([e],10,c).forEach(function(n){var a=fs.toDir(e),t=fs.toDir(n.replace(a,outdir));fs.mkPath(t),fs.copyFileSync(n,t)})})),r.length){var p=navOptions.sourceRootPath;p||(p=path.commonPrefix(r)),i=shortenPaths(i,p)}data().each(function(e){var n,a=helper.createLink(e);helper.registerLink(e.longname,a),e.meta&&(n=getPathFromDoclet(e),_.isEmpty(i[n])||(n=i[n].shortened)&&(e.meta.shortpath=n))}),data().each(function(e){helper.longnameToUrl[e.longname].indexOf("#")>-1?e.id=helper.longnameToUrl[e.longname].split(/#/).pop():e.id=e.name,needsSignature(e)&&(addSignatureParams(e),addSignatureReturns(e),addAttribs(e))}),data().each(function(e){e.ancestors=getAncestorLinks(e),"member"===e.kind&&(addSignatureTypes(e),addAttribs(e)),"constant"===e.kind&&(addSignatureTypes(e),addAttribs(e),e.kind="member")});var h=helper.getMembers(data);h.tutorials=a.children,view.find=find,view.linkto=linkto,view.resolveAuthorLinks=resolveAuthorLinks,view.tutoriallink=tutoriallink,view.htmlsafe=htmlsafe,view.moment=moment,buildNav(h),view.nav=navigationMaster,view.navOptions=navOptions,attachModuleSymbols(find({kind:["class","function"],longname:{left:"module:"}}),h.modules),navOptions.outputSourceFiles&&generateSourceFiles(i),h.globals.length&&generate("global","Global",[{kind:"globalobj"}],globalUrl),view.nav.module&&view.nav.module.members.length&&generate("module",view.nav.module.title,[{kind:"sectionIndex",contents:view.nav.module}],navigationMaster.module.link),view.nav.class&&view.nav.class.members.length&&generate("class",view.nav.class.title,[{kind:"sectionIndex",contents:view.nav.class}],navigationMaster.class.link),view.nav.namespace&&view.nav.namespace.members.length&&generate("namespace",view.nav.namespace.title,[{kind:"sectionIndex",contents:view.nav.namespace}],navigationMaster.namespace.link),view.nav.mixin&&view.nav.mixin.members.length&&generate("mixin",view.nav.mixin.title,[{kind:"sectionIndex",contents:view.nav.mixin}],navigationMaster.mixin.link),view.nav.interface&&view.nav.interface.members.length&&generate("interface",view.nav.interface.title,[{kind:"sectionIndex",contents:view.nav.interface}],navigationMaster.interface.link),view.nav.external&&view.nav.external.members.length&&generate("external",view.nav.external.title,[{kind:"sectionIndex",contents:view.nav.external}],navigationMaster.external.link),view.nav.tutorial&&view.nav.tutorial.members.length&&generate("tutorial",view.nav.tutorial.title,[{kind:"sectionIndex",contents:view.nav.tutorial}],navigationMaster.tutorial.link);var d=find({kind:"file"});generate("index","Index",find({kind:"package"}).concat([{kind:"mainpage",readme:n.readme,longname:n.mainpagetitle?n.mainpagetitle:"Main Page"}]).concat(d),indexUrl);var g,f,v,b,k,x,w,y=taffy(h.classes),F=taffy(h.modules),P=taffy(h.namespaces),S=taffy(h.mixins),E=taffy(h.interfaces),O=taffy(h.externals);for(var T in helper.longnameToUrl)if(hasOwnProp.call(helper.longnameToUrl,T)){var U=helper.find(y,{longname:T});U.length&&generate("class","Class: "+U[0].name,U,helper.longnameToUrl[T]);var q=helper.find(F,{longname:T});q.length&&generate("module","Module: "+q[0].name,q,helper.longnameToUrl[T]);var j=helper.find(P,{longname:T});j.length&&generate("namespace","Namespace: "+j[0].name,j,helper.longnameToUrl[T]);var L=helper.find(S,{longname:T});L.length&&generate("mixin","Mixin: "+L[0].name,L,helper.longnameToUrl[T]);var M=helper.find(E,{longname:T});M.length&&generate("interface","Interface: "+M[0].name,M,helper.longnameToUrl[T]);var D=helper.find(O,{longname:T});D.length&&generate("external","External: "+D[0].name,D,helper.longnameToUrl[T])}!function e(n){n.children.forEach(function(n){var a,t,l,i,r,o;a="Tutorial: "+n.title,t=n,l=helper.tutorialToUrl(n.name),i={title:a,header:t.title,content:t.parse(),children:t.children,docs:null},r=path.join(outdir,l),o=view.render("tutorial.tmpl",i),o=helper.resolveLinks(o),searchEnabled&&(searchableDocuments[l]={id:l,title:a,body:searchData(o)}),fs.writeFileSync(r,o,"utf8"),e(n)})}(a),searchEnabled&&(g=t+"/tmpl",f=searchableDocuments,v=navOptions,b={searchableDocuments:JSON.stringify(f),navOptions:v},k=fs.readFileSync(g+"/quicksearch.tmpl").toString(),x=_.template(k)(b),w=path.join(outdir,"quicksearch.html"),fs.writeFileSync(w,x,"utf8"))};