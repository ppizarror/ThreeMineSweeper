var WEBGL_CONSTANTS={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,FLOAT:5126,UNSIGNED_INT:5125,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};var THREE_TO_WEBGL={1003:WEBGL_CONSTANTS.NEAREST,1004:WEBGL_CONSTANTS.NEAREST_MIPMAP_NEAREST,1005:WEBGL_CONSTANTS.NEAREST_MIPMAP_LINEAR,1006:WEBGL_CONSTANTS.LINEAR,1007:WEBGL_CONSTANTS.LINEAR_MIPMAP_NEAREST,1008:WEBGL_CONSTANTS.LINEAR_MIPMAP_LINEAR};var PATH_PROPERTIES={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};THREE.GLTFExporter=function(){};THREE.GLTFExporter.prototype={constructor:THREE.GLTFExporter,parse:function(c,r,z){var g={binary:false,trs:false,onlyVisible:true,truncateDrawRange:true,embedImages:true,animations:[],forceIndices:false,forcePowerOfTwoTextures:false};z=Object.assign({},g,z);if(z.animations.length>0){z.trs=true}var d={asset:{version:"2.0",generator:"THREE.GLTFExporter"}};var w=0;var A=[];var o=[];var K=new Map();var m=[];var F={};var x={attributes:new Map(),materials:new Map(),textures:new Map()};var u;function k(N,M){return(N.length===M.length)&&N.every(function(P,O){return P===M[O]})}function y(P){if(window.TextEncoder!==undefined){return new TextEncoder().encode(P).buffer}var Q=new Uint8Array(new ArrayBuffer(P.length));for(var N=0,M=P.length;N<M;N++){var O=P.charCodeAt(N);Q[N]=O>255?32:O}return Q.buffer}function v(Q,S,P){var N={min:new Array(Q.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(Q.itemSize).fill(Number.NEGATIVE_INFINITY)};for(var O=S;O<S+P;O++){for(var M=0;M<Q.itemSize;M++){var R=Q.array[O*Q.itemSize+M];N.min[M]=Math.min(N.min[M],R);N.max[M]=Math.max(N.max[M],R)}}return N}function H(M){return THREE.Math.isPowerOfTwo(M.width)&&THREE.Math.isPowerOfTwo(M.height)}function G(P){if(x.attributes.has(P)){return false}var N=new THREE.Vector3();for(var O=0,M=P.count;O<M;O++){if(Math.abs(N.fromArray(P.array,O*3).length()-1)>0.0005){return false}}return true}function E(Q){if(x.attributes.has(Q)){return x.textures.get(Q)}var P=Q.clone();var N=new THREE.Vector3();for(var O=0,M=P.count;O<M;O++){N.fromArray(P.array,O*3);if(N.x===0&&N.y===0&&N.z===0){N.setX(1)}else{N.normalize()}N.toArray(P.array,O*3)}x.attributes.set(Q,P);return P}function n(M){return Math.ceil(M/4)*4}function i(O,P){P=P||0;var M=n(O.byteLength);if(M!==O.byteLength){var Q=new Uint8Array(M);Q.set(new Uint8Array(O));if(P!==0){for(var N=O.byteLength;N<M;N++){Q[N]=P}}return Q.buffer}return O}function f(N){try{return JSON.parse(JSON.stringify(N.userData))}catch(M){console.warn("THREE.GLTFExporter: userData of '"+N.name+"' won't be serialized because of JSON.stringify error - "+M.message);return{}}}function p(M){if(!d.buffers){d.buffers=[{byteLength:0}]}A.push(M);return 0}function C(N,P,M,S,U){if(!d.bufferViews){d.bufferViews=[]}var T;if(P===WEBGL_CONSTANTS.UNSIGNED_BYTE){T=1}else{if(P===WEBGL_CONSTANTS.UNSIGNED_SHORT){T=2}else{T=4}}var Z=n(S*N.itemSize*T);var X=new DataView(new ArrayBuffer(Z));var Q=0;for(var R=M;R<M+S;R++){for(var V=0;V<N.itemSize;V++){var W=N.array[R*N.itemSize+V];if(P===WEBGL_CONSTANTS.FLOAT){X.setFloat32(Q,W,true)}else{if(P===WEBGL_CONSTANTS.UNSIGNED_INT){X.setUint32(Q,W,true)}else{if(P===WEBGL_CONSTANTS.UNSIGNED_SHORT){X.setUint16(Q,W,true)}else{if(P===WEBGL_CONSTANTS.UNSIGNED_BYTE){X.setUint8(Q,W)}}}}Q+=T}}var Y={buffer:p(X.buffer),byteOffset:w,byteLength:Z};if(U!==undefined){Y.target=U}if(U===WEBGL_CONSTANTS.ARRAY_BUFFER){Y.byteStride=N.itemSize*T}w+=Z;d.bufferViews.push(Y);var O={id:d.bufferViews.length-1,byteLength:0};return O}function B(M){if(!d.bufferViews){d.bufferViews=[]}return new Promise(function(O){var N=new window.FileReader();N.readAsArrayBuffer(M);N.onloadend=function(){var P=i(N.result);var Q={buffer:p(P),byteOffset:w,byteLength:P.byteLength};w+=P.byteLength;d.bufferViews.push(Q);O(d.bufferViews.length-1)}})}function b(N,V,M,R){var S={1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"};var O;if(N.array.constructor===Float32Array){O=WEBGL_CONSTANTS.FLOAT}else{if(N.array.constructor===Uint32Array){O=WEBGL_CONSTANTS.UNSIGNED_INT}else{if(N.array.constructor===Uint16Array){O=WEBGL_CONSTANTS.UNSIGNED_SHORT}else{if(N.array.constructor===Uint8Array){O=WEBGL_CONSTANTS.UNSIGNED_BYTE}else{throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.")}}}}if(M===undefined){M=0}if(R===undefined){R=N.count}if(z.truncateDrawRange&&V!==undefined&&V.index===null){var P=M+R;var T=V.drawRange.count===Infinity?N.count:V.drawRange.start+V.drawRange.count;M=Math.max(M,V.drawRange.start);R=Math.min(P,T)-M;if(R<0){R=0}}if(R===0){return null}var Q=v(N,M,R);var U;if(V!==undefined){U=N===V.index?WEBGL_CONSTANTS.ELEMENT_ARRAY_BUFFER:WEBGL_CONSTANTS.ARRAY_BUFFER}var X=C(N,O,M,R,U);var W={bufferView:X.id,byteOffset:X.byteOffset,componentType:O,count:R,max:Q.max,min:Q.min,type:S[N.itemSize]};if(!d.accessors){d.accessors=[]}d.accessors.push(W);return d.accessors.length-1}function J(O){if(!d.images){d.images=[]}var P=O.format===THREE.RGBAFormat?"image/png":"image/jpeg";var Q={mimeType:P};if(z.embedImages){var N=u=u||document.createElement("canvas");N.width=O.image.width;N.height=O.image.height;if(z.forcePowerOfTwoTextures&&!H(O.image)){console.warn("GLTFExporter: Resized non-power-of-two image.",O.image);N.width=THREE.Math.floorPowerOfTwo(N.width);N.height=THREE.Math.floorPowerOfTwo(N.height)}var M=N.getContext("2d");if(O.flipY===true){M.translate(0,N.height);M.scale(1,-1)}M.drawImage(O.image,0,0,N.width,N.height);if(z.binary===true){o.push(new Promise(function(R){N.toBlob(function(S){B(S).then(function(T){Q.bufferView=T;R()})},P)}))}else{Q.uri=N.toDataURL(P)}}else{Q.uri=O.image.src}d.images.push(Q);return d.images.length-1}function t(N){if(!d.samplers){d.samplers=[]}var M={magFilter:THREE_TO_WEBGL[N.magFilter],minFilter:THREE_TO_WEBGL[N.minFilter],wrapS:THREE_TO_WEBGL[N.wrapS],wrapT:THREE_TO_WEBGL[N.wrapT]};d.samplers.push(M);return d.samplers.length-1}function L(N){if(x.textures.has(N)){return x.textures.get(N)}if(!d.textures){d.textures=[]}var O={sampler:t(N),source:J(N)};d.textures.push(O);var M=d.textures.length-1;x.textures.set(N,M);return M}function h(P){if(x.materials.has(P)){return x.materials.get(P)}if(!d.materials){d.materials=[]}if(P.isShaderMaterial){console.warn("GLTFExporter: THREE.ShaderMaterial not supported.");return null}var M={pbrMetallicRoughness:{}};if(P.isMeshBasicMaterial){M.extensions={KHR_materials_unlit:{}};F.KHR_materials_unlit=true}else{if(!P.isMeshStandardMaterial){console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.")}}var N=P.color.toArray().concat([P.opacity]);if(!k(N,[1,1,1,1])){M.pbrMetallicRoughness.baseColorFactor=N}if(P.isMeshStandardMaterial){M.pbrMetallicRoughness.metallicFactor=P.metalness;M.pbrMetallicRoughness.roughnessFactor=P.roughness}else{if(P.isMeshBasicMaterial){M.pbrMetallicRoughness.metallicFactor=0;M.pbrMetallicRoughness.roughnessFactor=0.9}else{M.pbrMetallicRoughness.metallicFactor=0.5;M.pbrMetallicRoughness.roughnessFactor=0.5}}if(P.metalnessMap||P.roughnessMap){if(P.metalnessMap===P.roughnessMap){M.pbrMetallicRoughness.metallicRoughnessTexture={index:L(P.metalnessMap)}}else{console.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.")}}if(P.map){M.pbrMetallicRoughness.baseColorTexture={index:L(P.map)}}if(P.isMeshBasicMaterial||P.isLineBasicMaterial||P.isPointsMaterial){}else{var Q=P.emissive.clone().multiplyScalar(P.emissiveIntensity).toArray();if(!k(Q,[0,0,0])){M.emissiveFactor=Q}if(P.emissiveMap){M.emissiveTexture={index:L(P.emissiveMap)}}}if(P.normalMap){M.normalTexture={index:L(P.normalMap)};if(P.normalScale.x!==-1){if(P.normalScale.x!==P.normalScale.y){console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X.")}M.normalTexture.scale=P.normalScale.x}}if(P.aoMap){M.occlusionTexture={index:L(P.aoMap)};if(P.aoMapIntensity!==1){M.occlusionTexture.strength=P.aoMapIntensity}}if(P.transparent||P.alphaTest>0){M.alphaMode=P.opacity<1?"BLEND":"MASK";if(P.alphaTest>0&&P.alphaTest!==0.5){M.alphaCutoff=P.alphaTest}}if(P.side===THREE.DoubleSide){M.doubleSided=true}if(P.name!==""){M.name=P.name}if(Object.keys(P.userData).length>0){M.extras=f(P)}d.materials.push(M);var O=d.materials.length-1;x.materials.set(P,O);return O}function e(M){var V=M.geometry;var ag;if(M.isLineSegments){ag=WEBGL_CONSTANTS.LINES}else{if(M.isLineLoop){ag=WEBGL_CONSTANTS.LINE_LOOP}else{if(M.isLine){ag=WEBGL_CONSTANTS.LINE_STRIP}else{if(M.isPoints){ag=WEBGL_CONSTANTS.POINTS}else{if(!V.isBufferGeometry){var aj=new THREE.BufferGeometry();aj.fromGeometry(V);V=aj}if(M.drawMode===THREE.TriangleFanDrawMode){console.warn("GLTFExporter: TriangleFanDrawMode and wireframe incompatible.");ag=WEBGL_CONSTANTS.TRIANGLE_FAN}else{if(M.drawMode===THREE.TriangleStripDrawMode){ag=M.material.wireframe?WEBGL_CONSTANTS.LINE_STRIP:WEBGL_CONSTANTS.TRIANGLE_STRIP}else{ag=M.material.wireframe?WEBGL_CONSTANTS.LINES:WEBGL_CONSTANTS.TRIANGLES}}}}}}var ac={};var aa={};var ao=[];var at=[];var O={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"};var P=V.getAttribute("normal");if(P!==undefined&&!G(P)){console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one.");V.addAttribute("normal",E(P))}for(var ai in V.attributes){var ae=V.attributes[ai];ai=O[ai]||ai.toUpperCase();var Z=ae.array;if(ai==="JOINTS_0"&&!(Z instanceof Uint16Array)&&!(Z instanceof Uint8Array)){console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.');ae=new THREE.BufferAttribute(new Uint16Array(Z),ae.itemSize,ae.normalized)}if(ai.substr(0,5)!=="MORPH"){var N=b(ae,V);if(N!==null){aa[ai]=N}}}if(P!==undefined){V.addAttribute("normal",P)}if(Object.keys(aa).length===0){return null}if(M.morphTargetInfluences!==undefined&&M.morphTargetInfluences.length>0){var ar=[];var T=[];var R={};if(M.morphTargetDictionary!==undefined){for(var av in M.morphTargetDictionary){R[M.morphTargetDictionary[av]]=av}}for(var al=0;al<M.morphTargetInfluences.length;++al){var au={};var ah=false;for(var ai in V.morphAttributes){if(ai!=="position"&&ai!=="normal"){if(!ah){console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported.");ah=true}continue}var ae=V.morphAttributes[ai][al];var Q=V.attributes[ai];var aq=ae.clone();for(var ak=0,am=ae.count;ak<am;ak++){aq.setXYZ(ak,ae.getX(ak)-Q.getX(ak),ae.getY(ak)-Q.getY(ak),ae.getZ(ak)-Q.getZ(ak))}au[ai.toUpperCase()]=b(aq,V)}at.push(au);ar.push(M.morphTargetInfluences[al]);if(M.morphTargetDictionary!==undefined){T.push(R[al])}}ac.weights=ar;if(T.length>0){ac.extras={};ac.extras.targetNames=T}}var X=(Object.keys(V.userData).length>0)?f(V):undefined;var Y=z.forceIndices;var an=Array.isArray(M.material);if(an&&M.geometry.groups.length===0){return null}if(!Y&&V.index===null&&an){console.warn("THREE.GLTFExporter: Creating index for non-indexed multi-material mesh.");Y=true}var U=false;if(V.index===null&&Y){var W=[];for(var al=0,ab=V.attributes.position.count;al<ab;al++){W[al]=al}V.setIndex(W);U=true}var S=an?M.material:[M.material];var ap=an?M.geometry.groups:[{materialIndex:0,start:undefined,count:undefined}];for(var al=0,ab=ap.length;al<ab;al++){var af={mode:ag,attributes:aa};if(X){af.extras=X}if(at.length>0){af.targets=at}if(V.index!==null){af.indices=b(V.index,V,ap[al].start,ap[al].count)}var ad=h(S[ap[al].materialIndex]);if(ad!==null){af.material=ad}ao.push(af)}if(U){V.setIndex(null)}ac.primitives=ao;if(!d.meshes){d.meshes=[]}d.meshes.push(ac);return d.meshes.length-1}function j(O){if(!d.cameras){d.cameras=[]}var M=O.isOrthographicCamera;var N={type:M?"orthographic":"perspective"};if(M){N.orthographic={xmag:O.right*2,ymag:O.top*2,zfar:O.far<=0?0.001:O.far,znear:O.near<0?0:O.near}}else{N.perspective={aspectRatio:O.aspect,yfov:THREE.Math.degToRad(O.fov)/O.aspect,zfar:O.far<=0?0.001:O.far,znear:O.near<0?0:O.near}}if(O.name!==""){N.name=O.type}d.cameras.push(N);return d.cameras.length-1}function D(P,X){if(!d.animations){d.animations=[]}var T=[];var W=[];for(var S=0;S<P.tracks.length;++S){var O=P.tracks[S];var V=THREE.PropertyBinding.parseTrackName(O.name);var M=THREE.PropertyBinding.findNode(X,V.nodeName);var U=PATH_PROPERTIES[V.propertyName];if(V.objectName==="bones"){if(M.isSkinnedMesh===true){M=M.skeleton.getBoneByName(V.objectIndex)}else{M=undefined}}if(!M||!U){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',O.name);return null}var R=1;var N=O.values.length/O.times.length;if(U===PATH_PROPERTIES.morphTargetInfluences){N/=M.morphTargetInfluences.length}var Q;if(O.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===true){Q="CUBICSPLINE";N/=3}else{if(O.getInterpolation()===THREE.InterpolateDiscrete){Q="STEP"}else{Q="LINEAR"}}W.push({input:b(new THREE.BufferAttribute(O.times,R)),output:b(new THREE.BufferAttribute(O.values,N)),interpolation:Q});T.push({sampler:W.length-1,target:{node:K.get(M),path:U}})}d.animations.push({name:P.name||"clip_"+d.animations.length,samplers:W,channels:T});return d.animations.length-1}function a(O){var R=d.nodes[K.get(O)];var S=O.skeleton;var Q=O.skeleton.bones[0];if(Q===undefined){return null}var M=[];var T=new Float32Array(S.bones.length*16);for(var P=0;P<S.bones.length;++P){M.push(K.get(S.bones[P]));S.boneInverses[P].toArray(T,P*16)}if(d.skins===undefined){d.skins=[]}d.skins.push({inverseBindMatrices:b(new THREE.BufferAttribute(T,16)),joints:M,skeleton:K.get(Q)});var N=R.skin=d.skins.length-1;return N}function q(T){if(T.isLight){console.warn("GLTFExporter: Unsupported node type:",T.constructor.name);return null}if(!d.nodes){d.nodes=[]}var S={};if(z.trs){var W=T.quaternion.toArray();var V=T.position.toArray();var R=T.scale.toArray();if(!k(W,[0,0,0,1])){S.rotation=W}if(!k(V,[0,0,0])){S.translation=V}if(!k(R,[1,1,1])){S.scale=R}}else{T.updateMatrix();if(!k(T.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])){S.matrix=T.matrix.elements}}if(T.name!==""){S.name=String(T.name)}if(T.userData&&Object.keys(T.userData).length>0){S.extras=f(T)}if(T.isMesh||T.isLine||T.isPoints){var X=e(T);if(X!==null){S.mesh=X}}else{if(T.isCamera){S.camera=j(T)}}if(T.isSkinnedMesh){m.push(T)}if(T.children.length>0){var N=[];for(var U=0,Q=T.children.length;U<Q;U++){var M=T.children[U];if(M.visible||z.onlyVisible===false){var O=q(M);if(O!==null){N.push(O)}}}if(N.length>0){S.children=N}}d.nodes.push(S);var P=d.nodes.length-1;K.set(T,P);return P}function l(Q){if(!d.scenes){d.scenes=[];d.scene=0}var S={nodes:[]};if(Q.name!==""){S.name=Q.name}d.scenes.push(S);var N=[];for(var O=0,M=Q.children.length;O<M;O++){var R=Q.children[O];if(R.visible||z.onlyVisible===false){var P=q(R);if(P!==null){N.push(P)}}}if(N.length>0){S.nodes=N}}function s(N){var O=new THREE.Scene();O.name="AuxScene";for(var M=0;M<N.length;M++){O.children.push(N[M])}l(O)}function I(N){N=N instanceof Array?N:[N];var M=[];for(var O=0;O<N.length;O++){if(N[O] instanceof THREE.Scene){l(N[O])}else{M.push(N[O])}}if(M.length>0){s(M)}for(var O=0;O<m.length;++O){a(m[O])}for(var O=0;O<z.animations.length;++O){D(z.animations[O],N[0])}}I(c);Promise.all(o).then(function(){var M=new Blob(A,{type:"application/octet-stream"});var S=Object.keys(F);if(S.length>0){d.extensionsUsed=S}if(d.buffers&&d.buffers.length>0){d.buffers[0].byteLength=M.size;var T=new window.FileReader();if(z.binary===true){var R=12;var O=1179937895;var N=2;var U=8;var Q=1313821514;var P=5130562;T.readAsArrayBuffer(M);T.onloadend=function(){var X=i(T.result);var aa=new DataView(new ArrayBuffer(U));aa.setUint32(0,X.byteLength,true);aa.setUint32(4,P,true);var ab=i(y(JSON.stringify(d)),32);var W=new DataView(new ArrayBuffer(U));W.setUint32(0,ab.byteLength,true);W.setUint32(4,Q,true);var Z=new ArrayBuffer(R);var Y=new DataView(Z);Y.setUint32(0,O,true);Y.setUint32(4,N,true);var V=R+W.byteLength+ab.byteLength+aa.byteLength+X.byteLength;Y.setUint32(8,V,true);var ad=new Blob([Z,W,ab,aa,X],{type:"application/octet-stream"});var ac=new window.FileReader();ac.readAsArrayBuffer(ad);ac.onloadend=function(){r(ac.result)}}}else{T.readAsDataURL(M);T.onloadend=function(){var V=T.result;d.buffers[0].uri=V;r(d)}}}else{r(d)}})}};