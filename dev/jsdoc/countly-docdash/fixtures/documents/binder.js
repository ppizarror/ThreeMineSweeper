"use strict";var Promise=require("promise");var async=require("async");var probe=require("./probe");var sys=require("lodash");var dataBinderOptions=exports.dataBinderOptions={getter:null,getterAsync:false,setter:null,validator:null,validatorAsync:false,setterAsync:false};exports.unbind=function(g,b){var e=b;var a=e;var f=g.split(probe.delimiter);var d=g;var c;sys.each(f,function(i){c=i;a=e;e=e[i];d=i;if(sys.isNull(e)||sys.isUndefined(e)){e={}}});if(a===e){h(b,d)}else{h(a,d)}function h(j,i){j[i]=j["__"+i+"__"];delete j["__"+i+"__"]}};exports.bind=function(h,f,i){i=sys.extend({},dataBinderOptions,i);var b=f;var g=b;var d=h.split(probe.delimiter);var c=h;var e;sys.each(d,function(j){e=j;g=b;b=b[j];c=j;if(sys.isNull(b)||sys.isUndefined(b)){b={}}});if(g===b){a(f,c)}else{a(g,c)}function a(k,j){k["__"+j+"__"]=k[j];Object.defineProperty(k,j,{get:function(){if(sys.isFunction(i.getter)){var l;if(i.getterAsync===true){l=Promise.denodeify(i.getter)}if(l){return l(k["__"+j+"__"]).then(function(m){k["__"+j+"__"]=m})}else{k["__"+j+"__"]=i.getter(k["__"+j+"__"]);return k["__"+j+"__"]}}else{return k["__"+j+"__"]}},set:function(l){async.waterfall([function(m){if(sys.isFunction(i.validator)){if(i.validatorAsync){i.validator(l,k["__"+j+"__"],f,m)}else{var n=i.validator(l,k["__"+j+"__"],f);if(n===true){m()}else{m(n)}}}else{m()}},function(m){if(sys.isFunction(i.setter)){if(i.setterAsync===true){i.setter(l,k["__"+j+"__"],f,m)}else{m(null,i.setter(l,k["__"+j+"__"],f))}}else{m(null,l)}}],function(n,m){if(n){throw new Error(n)}k["__"+j+"__"]=m})}})}return b};