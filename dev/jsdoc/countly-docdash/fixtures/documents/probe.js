"use strict";var sys=require("lodash");var nestedOps=["$eq","$gt","$gte","$in","$lt","$lte","$ne","$nin","$exists","$mod","$size","$all"];var prefixOps=["$and","$or","$nor","$not"];function processNestedOperator(c,a){var b=Object.keys(a);return{operation:b[0],operands:[a[b[0]]],path:c}}function processExpressionObject(d,b){var a;if(sys.isObject(d)){var c=Object.keys(d);var e=c[0];if(sys.indexOf(nestedOps,e)>-1){a=processNestedOperator(b,d)}else{if(sys.indexOf(prefixOps,b)>-1){a=processPrefixOperator(b,d)}else{if(e==="$regex"){a=processNestedOperator(b,d)}else{if(e==="$elemMatch"){a={path:b,operation:e,operands:[]};sys.each(d[e],function(f){a.operands=parseQueryExpression(f)})}else{throw new Error("Unrecognized operator")}}}}}else{a=processNestedOperator(b,{$eq:d})}return a}function processPrefixOperator(b,a){var c={operation:b,path:null,operands:[]};if(sys.isArray(a)){sys.each(a,function(d){sys.each(d,function(f,e){c.operands.push(processExpressionObject(f,e))})})}else{sys.each(a,function(e,d){c.operands.push(processExpressionObject(e,d))})}return c}function parseQueryExpression(c){if(sys.size(c)>1){var a=sys.map(c,function(e,d){var f={};f[d]=e;return f});c={$and:a}}var b=[];sys.each(c,function(f,d){var e=processExpressionObject(f,d);if(e.operation==="$regex"){e.options=f.$options}b.push(e)});return b}exports.delimiter=".";function splitPath(a){return a.split(exports.delimiter)}function reachin(f,b){var d=b;var c;var e;var a;for(e=0,a=f.length;e<a;e++){c=f[e];d=d[c];if(sys.isNull(d)||sys.isUndefined(d)){break}}return d}function pushin(j,f,d,a){var b=f;var h=f;var k=null;var e;var g;var c;var i;for(e=0,g=j.length;e<g;e++){c=j[e];k=c;h=b;b=b[c];if(sys.isNull(b)||sys.isUndefined(b)){h[c]={};b=h[c]}}if(sys.isEmpty(d)||d==="$set"){h[k]=a;return h[k]}else{switch(d){case"$inc":if(!sys.isNumber(a)){a=1}if(sys.isNumber(h[k])){h[k]=h[k]+a;return h[k]}break;case"$dec":if(!sys.isNumber(a)){a=1}if(sys.isNumber(h[k])){h[k]=h[k]-a;return h[k]}break;case"$unset":return delete h[k];case"$pop":if(sys.isArray(h[k])){if(!sys.isNumber(a)){a=1}if(a===1){return h[k].pop()}else{return h[k].shift()}}break;case"$push":if(sys.isArray(h[k])){return h[k].push(a)}break;case"$pull":if(sys.isArray(h[k])){i=exports.findKeys(h[k],a);sys.each(i,function(m,l){return delete h[k][l]});h[k]=sys.compact(h[k]);return h[k]}}}}var operations={$eq:function(b,a){if(sys.isArray(a)){return sys.find(a,function(c){return JSON.stringify(b.operands[0])===JSON.stringify(c)})!==void 0}else{return JSON.stringify(b.operands[0])===JSON.stringify(a)}},$ne:function(b,a){if(sys.isArray(a)){return sys.find(a,function(c){return JSON.stringify(b.operands[0])!==JSON.stringify(c)})!==void 0}else{return JSON.stringify(b.operands[0])!==JSON.stringify(a)}},$all:function(d,c){var b,a;a=false;if(sys.isArray(c)){b=sys.flatten(d.operands);a=sys.intersection(b,c).length===b.length}return a},$gt:function(b,a){return b.operands[0]<a},$gte:function(b,a){return b.operands[0]<=a},$lt:function(b,a){return b.operands[0]>a},$lte:function(b,a){return b.operands[0]>=a},$in:function(c,b){var a;a=sys.flatten(c.operands);return sys.indexOf(a,b)>-1},$nin:function(c,b){var a;a=sys.flatten(c.operands);return sys.indexOf(a,b)===-1},$exists:function(b,a){return(sys.isNull(a)||sys.isUndefined(a))!==b.operands[0]},$mod:function(d,c){var a=sys.flatten(d.operands);if(a.length!==2){throw new Error("$mod requires two operands")}var b=a[0];var e=a[1];return c%b===e},$size:function(b,a){return sys.size(a)===b.operands[0]},$regex:function(c,b){var a=new RegExp(c.operands[0],c.options);return a.test(b)},$elemMatch:function(f,d){var e,g,c,a;if(sys.isArray(d)){var b=f.operands;for(c=0,a=b.length;c<a;c++){e=b[c];if(e.path){e.splitPath=splitPath(e.path)}}g=execQuery(d,f.operands,null,true).arrayResults}return g.length>0},$and:function(d,c,b){var a=false;sys.each(d.operands,function(e){if(e.path){e.splitPath=e.splitPath||splitPath(e.path)}var f=reachin(e.splitPath,b,e.operation);a=operations[e.operation](e,f,b);if(!a){return false}});return a},$or:function(d,c,a){var b=false;sys.each(d.operands,function(e){if(e.path){e.splitPath=e.splitPath||splitPath(e.path)}var f=reachin(e.splitPath,a,e.operation);b=operations[e.operation](e,f,a);if(b){return false}});return b},$nor:function(d,c,a){var b=false;sys.each(d.operands,function(e){if(e.path){e.splitPath=e.splitPath||splitPath(e.path)}var f=reachin(e.splitPath,a,e.operation);b=operations[e.operation](e,f,a);if(b){return false}});return !b},$not:function(d,c,b){var a=false;sys.each(d.operands,function(e){if(e.path){e.splitPath=e.splitPath||splitPath(e.path)}var f=reachin(e.splitPath,b,e.operation);a=operations[e.operation](e,f,b);if(a){return false}});return !a}};function execQuery(e,f,d,b){var a=[];var c=[];sys.each(e,function(i,j){var l,g,m,k,h;for(k=0,h=f.length;k<h;k++){l=f[k];if(l.splitPath){m=reachin(l.splitPath,i,l.operation)}g=operations[l.operation](l,m,i);if(g){a.push(i);c.push(j)}if(!g&&d){break}}if(a.length>0&&b){return false}});return{arrayResults:a,keyResults:c}}exports.update=function(c,d,b){var a=exports.find(c,d);return sys.each(a,function(e){return sys.each(b,function(f,g){return sys.each(f,function(i,h){return pushin(splitPath(h),e,g,i)})})})};exports.find=function(d,f){var e,c,a;var b=parseQueryExpression(f);for(c=0,a=b.length;c<a;c++){e=b[c];if(e.path){e.splitPath=splitPath(e.path)}}return execQuery(d,b).arrayResults};exports.findKeys=function(d,f){var e,c,a;var b=parseQueryExpression(f);for(c=0,a=b.length;c<a;c++){e=b[c];if(e.path){e.splitPath=splitPath(e.path)}}return execQuery(d,b).keyResults};exports.findOne=function(e,g){var f,d,a;var c=parseQueryExpression(g);for(d=0,a=c.length;d<a;d++){f=c[d];if(f.path){f.splitPath=splitPath(f.path)}}var b=execQuery(e,c,false,true).arrayResults;if(b.length>0){return b[0]}else{return null}};exports.seek=exports.findOne;exports.findOneKey=function(e,g){var f,d,a;var c=parseQueryExpression(g);for(d=0,a=c.length;d<a;d++){f=c[d];if(f.path){f.splitPath=splitPath(f.path)}}var b=execQuery(e,c,false,true).keyResults;if(b.length>0){return b[0]}else{return null}};exports.seekKey=exports.findOneKey;exports.remove=function(f,h){var g,e,a;var d=parseQueryExpression(h);for(e=0,a=d.length;e<a;e++){g=d[e];if(g.path){g.splitPath=splitPath(g.path)}}var b=execQuery(f,d,false,false).keyResults;if(sys.isArray(f)){var c=[];sys.each(f,function(j,i){if(sys.indexOf(b,i)===-1){return c.push(j)}});return c}else{sys.each(b,function(i){return delete f[i]});return f}};exports.all=function(a,b){return exports.find(a,b).length===sys.size(a)};exports.any=function(e,g){var f,d,a;var c=parseQueryExpression(g);for(d=0,a=c.length;d<a;d++){f=c[d];if(f.path){f.splitPath=splitPath(f.path)}}var b=execQuery(e,c,true,true).keyResults;return b.length>0};exports.unique=function(a,b){var c=exports.find(a,b);return sys.unique(c,function(d){return JSON.stringify(d)})};exports.set=function(a,c,d,b){return pushin(splitPath(c),a,d,b)};exports.get=function(a,b){return reachin(splitPath(b),a)};exports.some=exports.any;exports.every=exports.all;var bindables={any:exports.any,all:exports.all,remove:exports.remove,seekKey:exports.seekKey,seek:exports.seek,findOneKey:exports.findOneKey,findOne:exports.findOne,findKeys:exports.findKeys,find:exports.find,update:exports.update,some:exports.some,every:exports.every,get:exports.get,set:exports.set};exports.proxy=function(b){var a;a={};sys.each(bindables,function(d,c){a[c]=sys.bind(d,b,b)});return a};exports.mixin=function(a,b){b=b||a;return sys.each(bindables,function(d,c){a[c]=sys.bind(d,a,b)})};