"use strict";var data,view,doop=require("jsdoc/util/doop"),fs=require("jsdoc/fs"),helper=require("jsdoc/util/templateHelper"),logger=require("jsdoc/util/logger"),path=require("jsdoc/path"),taffy=require("taffydb").taffy,template=require("jsdoc/template"),util=require("util"),htmlsafe=helper.htmlsafe,linkto=helper.linkto,resolveAuthorLinks=helper.resolveAuthorLinks,scopeToPunc=helper.scopeToPunc,hasOwnProp=Object.prototype.hasOwnProperty,outdir=path.normalize(env.opts.destination);function find(e){return helper.find(data,e)}function tutoriallink(e){return helper.toTutorial(e,null,{tag:"em",classname:"disabled",prefix:"Tutorial: "})}function getAncestorLinks(e){return helper.getAncestorLinks(data,e)}function hashToLink(e,n){if(!/^(#.+)/.test(n))return n;var t=helper.createLink(e);return'<a href="'+(t=t.replace(/(#.+|$)/,n))+'">'+n+"</a>"}function needsSignature(e){var n=!1;if("function"===e.kind||"class"===e.kind)n=!0;else if("typedef"===e.kind&&e.type&&e.type.names&&e.type.names.length)for(var t=0,a=e.type.names.length;t<a;t++)if("function"===e.type.names[t].toLowerCase()){n=!0;break}return n}function getSignatureAttributes(e){var n=[];return e.optional&&n.push("opt"),!0===e.nullable?n.push("nullable"):!1===e.nullable&&n.push("non-null"),n}function updateItemName(e){var n=getSignatureAttributes(e),t=e.name||"";return e.variable&&(t="&hellip;"+t),n&&n.length&&(t=util.format('%s<span class="signature-attributes">%s</span>',t,n.join(", "))),t}function addParamAttributes(e){return e.filter(function(e){return e.name&&-1===e.name.indexOf(".")}).map(updateItemName)}function buildItemTypeStrings(e){var n=[];return e&&e.type&&e.type.names&&e.type.names.forEach(function(e){n.push(linkto(e,htmlsafe(e)))}),n}function buildAttribsString(e){var n="";return e&&e.length&&(n=htmlsafe(util.format("(%s) ",e.join(", ")))),n}function addNonParamAttributes(e){var n=[];return e.forEach(function(e){n=n.concat(buildItemTypeStrings(e))}),n}function addSignatureParams(e){var n=e.params?addParamAttributes(e.params):[];e.signature=util.format("%s(%s)",e.signature||"",n.join(", "))}function addSignatureReturns(e){var n=[],t="",a=[],r="";e.returns&&(e.returns.forEach(function(e){helper.getAttribs(e).forEach(function(e){-1===n.indexOf(e)&&n.push(e)})}),t=buildAttribsString(n)),e.returns&&(a=addNonParamAttributes(e.returns)),a.length&&(r=util.format(" &rarr; %s{%s}",t,a.join("|"))),e.signature='<span class="signature">'+(e.signature||"")+'</span><span class="type-signature">'+r+"</span>"}function addSignatureTypes(e){var n=e.type?buildItemTypeStrings(e):[];e.signature=(e.signature||"")+'<span class="type-signature">'+(n.length?" :"+n.join("|"):"")+"</span>"}function addAttribs(e){var n=buildAttribsString(helper.getAttribs(e));e.attribs=util.format('<span class="type-signature">%s</span>',n)}function shortenPaths(e,n){return Object.keys(e).forEach(function(t){e[t].shortened=e[t].resolved.replace(n,"").replace(/\\/g,"/")}),e}function getPathFromDoclet(e){return e.meta?e.meta.path&&"null"!==e.meta.path?path.join(e.meta.path,e.meta.filename):e.meta.filename:null}function generate(e,n,t,a,r){r=!1!==r;var l={type:e,title:n,docs:t},i=path.join(outdir,a),o=view.render("container.tmpl",l);r&&(o=helper.resolveLinks(o)),fs.writeFileSync(i,o,"utf8")}function generateSourceFiles(e,n){n=n||"utf8",Object.keys(e).forEach(function(t){var a,r=helper.getUniqueFilename(e[t].shortened);helper.registerLink(e[t].shortened,r);try{a={kind:"source",code:helper.htmlsafe(fs.readFileSync(e[t].resolved,n))}}catch(e){logger.error("Error while generating source file %s: %s",t,e.message)}generate("Source",e[t].shortened,[a],r,!1)})}function attachModuleSymbols(e,n){var t={};return e.forEach(function(e){t[e.longname]=t[e.longname]||[],t[e.longname].push(e)}),n.map(function(e){t[e.longname]&&(e.modules=t[e.longname].filter(function(e){return e.description||"class"===e.kind}).map(function(e){return"class"!==(e=doop(e)).kind&&"function"!==e.kind||(e.name=e.name.replace("module:",'(require("')+'"))'),e}))})}function buildMemberNav(e,n,t,a){var r="";if(e&&e.length){var l="";e.forEach(function(e){var n=find({kind:"function",memberof:e.longname}),r=find({kind:"member",memberof:e.longname}),i=env&&env.conf&&env.conf.docdash||{};hasOwnProp.call(e,"longname")?hasOwnProp.call(t,e.longname)||(l+="<li>"+a(e.longname,e.name.replace(/^module:/,"")),i.static&&r.find(function(e){return"static"===e.scope})&&(l+="<ul class='members'>",r.forEach(function(e){"static"!==!e.scope&&(l+="<li data-type='member'",i.collapse&&(l+=" style='display: none;'"),l+=">",l+=linkto(e.longname,e.name),l+="</li>")}),l+="</ul>"),n.length&&(l+="<ul class='methods'>",n.forEach(function(e){l+="<li data-type='method'",i.collapse&&(l+=" style='display: none;'"),l+=">",l+=linkto(e.longname,e.name),l+="</li>"}),l+="</ul>"),l+="</li>",t[e.longname]=!0):(l+="<li>"+a("",e.name),l+="</li>")}),""!==l&&(r+="<h3>"+n+"</h3><ul>"+l+"</ul>")}return r}function linktoTutorial(e,n){return tutoriallink(n)}function linktoExternal(e,n){return linkto(e,n.replace(/(^"|"$)/g,""))}function buildNav(e){var n='<h2><a href="index.html">Home</a></h2>',t={},a=env&&env.conf&&env.conf.docdash||{};if(n+=buildMemberNav(e.classes,"Classes",t,linkto),n+=buildMemberNav(e.modules,"Modules",{},linkto),n+=buildMemberNav(e.externals,"Externals",t,linktoExternal),n+=buildMemberNav(e.events,"Events",t,linkto),n+=buildMemberNav(e.namespaces,"Namespaces",t,linkto),n+=buildMemberNav(e.mixins,"Mixins",t,linkto),n+=buildMemberNav(e.tutorials,"Tutorials",{},linktoTutorial),n+=buildMemberNav(e.interfaces,"Interfaces",t,linkto),e.globals.length){var r="";e.globals.forEach(function(e){!a.typedefs&&"typedef"===e.kind||hasOwnProp.call(t,e.longname)||(r+="<li>"+linkto(e.longname,e.name)+"</li>"),t[e.longname]=!0}),n+=r?"<h3>Global</h3><ul>"+r+"</ul>":"<h3>"+linkto("global","Global")+"</h3>"}return n}exports.publish=function(e,n,t){var a=env&&env.conf&&env.conf.docdash||{};data=e;var r=env.conf.templates||{};r.default=r.default||{};var l=path.normalize(n.template);view=new template.Template(path.join(l,"tmpl"));var i=helper.getUniqueFilename("index"),o=helper.getUniqueFilename("global");helper.registerLink("global",o),view.layout=r.default.layoutFile?path.getResourcePath(path.dirname(r.default.layoutFile),path.basename(r.default.layoutFile)):"layout.tmpl",helper.setTutorials(t),data=helper.prune(data),!1!==a.sort&&data.sort("longname, version, since"),helper.addEventListeners(data);var s={},u=[];data().each(function(e){var n;a.removeQuotes&&("all"===a.removeQuotes?(e.name&&(e.name=e.name.replace(/"/g,""),e.name=e.name.replace(/'/g,"")),e.longname&&(e.longname=e.longname.replace(/"/g,""),e.longname=e.longname.replace(/'/g,""))):"trim"===a.removeQuotes&&(e.name&&(e.name=e.name.replace(/^"(.*)"$/,"$1"),e.name=e.name.replace(/^'(.*)'$/,"$1")),e.longname&&(e.longname=e.longname.replace(/^"(.*)"$/,"$1"),e.longname=e.longname.replace(/^'(.*)'$/,"$1")))),e.attribs="",e.examples&&(e.examples=e.examples.map(function(e){var n,t;return e.match(/^\s*<caption>([\s\S]+?)<\/caption>(\s*[\n\r])([\s\S]+)$/i)&&(n=RegExp.$1,t=RegExp.$3),{caption:n||"",code:t||e}})),e.see&&e.see.forEach(function(n,t){e.see[t]=hashToLink(e,n)}),e.meta&&(n=getPathFromDoclet(e),s[n]={resolved:n,shortened:null},-1===u.indexOf(n)&&u.push(n))});var c=(find({kind:"package"})||[])[0];c&&c.name&&(outdir=path.join(outdir,c.name,c.version||"")),fs.mkPath(outdir);var m,d,p,f=path.join(l,"static");fs.ls(f,3).forEach(function(e){var n=fs.toDir(e.replace(f,outdir));fs.mkPath(n),fs.copyFileSync(e,n)}),r.default.staticFiles&&(m=r.default.staticFiles.include||r.default.staticFiles.paths||[],d=new(require("jsdoc/src/filter").Filter)(r.default.staticFiles),p=new(require("jsdoc/src/scanner").Scanner),m.forEach(function(e){p.scan([e],10,d).forEach(function(n){var t=fs.toDir(e),a=fs.toDir(n.replace(t,outdir));fs.mkPath(a),fs.copyFileSync(n,a)})})),u.length&&(s=shortenPaths(s,path.commonPrefix(u))),data().each(function(e){var n,t=helper.createLink(e);helper.registerLink(e.longname,t),e.meta&&(n=getPathFromDoclet(e),(n=s[n].shortened)&&(e.meta.shortpath=n))}),data().each(function(e){helper.longnameToUrl[e.longname].indexOf("#")>-1?e.id=helper.longnameToUrl[e.longname].split(/#/).pop():e.id=e.name,needsSignature(e)&&(addSignatureParams(e),addSignatureReturns(e),addAttribs(e))}),data().each(function(e){e.ancestors=getAncestorLinks(e),"member"===e.kind&&(addSignatureTypes(e),addAttribs(e)),"constant"===e.kind&&(addSignatureTypes(e),addAttribs(e),e.kind="member")});var h=helper.getMembers(data);h.tutorials=t.children;var g=!(!r.default||!1===r.default.outputSourceFiles);view.find=find,view.linkto=linkto,view.resolveAuthorLinks=resolveAuthorLinks,view.tutoriallink=tutoriallink,view.htmlsafe=htmlsafe,view.outputSourceFiles=g,view.nav=buildNav(h),attachModuleSymbols(find({longname:{left:"module:"}}),h.modules),g&&generateSourceFiles(s,n.encoding),h.globals.length&&generate("","Global",[{kind:"globalobj"}],o);var v=find({kind:"file"});generate("","Home",find({kind:"package"}).concat([{kind:"mainpage",readme:n.readme,longname:n.mainpagetitle?n.mainpagetitle:"Main Page"}]).concat(v),i);var b=taffy(h.classes),k=taffy(h.modules),y=taffy(h.namespaces),S=taffy(h.mixins),T=taffy(h.externals),E=taffy(h.interfaces);Object.keys(helper.longnameToUrl).forEach(function(e){var n=helper.find(k,{longname:e});n.length&&generate("Module",n[0].name,n,helper.longnameToUrl[e]);var t=helper.find(b,{longname:e});t.length&&generate("Class",t[0].name,t,helper.longnameToUrl[e]);var a=helper.find(y,{longname:e});a.length&&generate("Namespace",a[0].name,a,helper.longnameToUrl[e]);var r=helper.find(S,{longname:e});r.length&&generate("Mixin",r[0].name,r,helper.longnameToUrl[e]);var l=helper.find(T,{longname:e});l.length&&generate("External",l[0].name,l,helper.longnameToUrl[e]);var i=helper.find(E,{longname:e});i.length&&generate("Interface",i[0].name,i,helper.longnameToUrl[e])}),function e(n){n.children.forEach(function(n){var t,a,r,l,i,o;t="Tutorial: "+n.title,a=n,r=helper.tutorialToUrl(n.name),l={title:t,header:a.title,content:a.parse(),children:a.children},i=path.join(outdir,r),o=view.render("tutorial.tmpl",l),o=helper.resolveLinks(o),fs.writeFileSync(i,o,"utf8"),e(n)})}(t)};